"use strict";var _iterator=require("babel-runtime/core-js/symbol/iterator"),_iterator2=_interopRequireDefault(_iterator),_symbol=require("babel-runtime/core-js/symbol"),_symbol2=_interopRequireDefault(_symbol),_assign=require("babel-runtime/core-js/object/assign"),_assign2=_interopRequireDefault(_assign),_stringify=require("babel-runtime/core-js/json/stringify"),_stringify2=_interopRequireDefault(_stringify),_promise=require("babel-runtime/core-js/promise"),_promise2=_interopRequireDefault(_promise),_keys=require("babel-runtime/core-js/object/keys"),_keys2=_interopRequireDefault(_keys),_typeof="function"==typeof _symbol2.default&&"symbol"==typeof _iterator2.default?function(e){return typeof e}:function(e){return e&&"function"==typeof _symbol2.default&&e.constructor===_symbol2.default&&e!==_symbol2.default.prototype?"symbol":typeof e},_extends=_assign2.default||function(e){for(var n=1;n<arguments.length;n++){var t=arguments[n];for(var o in t)Object.prototype.hasOwnProperty.call(t,o)&&(e[o]=t[o])}return e};function _interopRequireDefault(e){return e&&e.__esModule?e:{default:e}}var Boom=require("boom"),ObjectId=require("mongodb").ObjectId,fs=require("fs"),config=require("config"),webPush=require("./lib/webPush"),simpleGit=require("simple-git")(config.get("application.dsxSourceLocation")).addConfig("user.name",config.get("application.gitUser")).addConfig("user.email",config.get("application.gitEmail")),simpleGitPBI=require("simple-git")(config.get("application.pbiSourceLocation")).addConfig("user.name",config.get("application.gitUser")).addConfig("user.email",config.get("application.gitEmail")),axios=require("axios"),_=require("lodash"),d3=require("d3-queue"),stringify=require("json-stable-stringify"),Handlebars=require("handlebars"),translate=require("translate");translate.engine="yandex",translate.key="trnsl.1.1.20180614T121111Z.0199abeacac8da58.dc0200799ded65a9ba3309c2c6c10f0e47faf9a0",exports.getComponents=function(e,n){var t=e.mongo.db;t.db("vbx_current").collection("vbxReleases").findOne({version:e.query.version},function(o,r){var i=r.dbName;(t=t.db(i)).collection("components").find(function(t,o){if(t)return n(Boom.internal("Internal MongoDB error",t));o.toArray().then(function(t){exports.getChangedComponents(e,n,function(e){n({componentList:t,lockedComponents:e})})})})})},exports.getProperties=function(e,n){var t=e.mongo.db,o=e.query.platform||"VBX";t.db("vbx_current").collection("vbxReleases").findOne({version:e.query.version},function(e,r){var i=r.dbName;(t=t.db(i)).collection("propertybank").find({platform:o},function(e,t){if(e)return n(Boom.internal("Internal MongoDB error",e));t.toArray().then(function(e){n(e)})})})},exports.getComponent=function(e,n){var t=e.params.componentId,o=e.mongo.db;o.db("vbx_current").collection("vbxReleases").findOne({version:e.query.version},function(r,i){var a=i.dbName;(o=o.db(a)).collection("componentSchema").findOne({componentId:t},function(t,r){if(t)return n(Boom.internal("Internal MongoDB error",t));var i=r.componentId,a=r._id.toString();e.query.schemaVersion&&"dev"===e.query.schemaVersion&&r.hasOwnProperty("isLocked")&&r.isLocked?o.collection("componentSchemaDev").findOne({schemaId:r._id.toString(),approvalStatus:"pending"},function(e,t){n({_id:a,componentId:i,sections:t.newSchema})}):n(r)})})},exports.updateComponent=function(e,n){var t=e.payload.schemaId,o=e.payload.sections,r=e.mongo.db;r.db("vbx_current").collection("vbxReleases").findOne({version:e.payload.version},function(e,i){var a=i.dbName;(r=r.db(a)).collection("componentSchema").updateOne({_id:ObjectId(t)},{$set:{sections:o}},{w:1},function(e,t){if(e)return n(Boom.internal("Internal MongoDB error",e));n(t)})})},exports.updateComponentOnDev=function(e,n){var t=e.payload.schemaId,o=e.payload.sections,r=e.payload.changeMsg,i=e.auth.credentials.user,a=e.auth.credentials._id,c=new Date,s=c.getFullYear()+"-"+(c.getMonth()+1)+"-"+c.getDate()+" "+c.getHours()+":"+c.getMinutes()+":"+c.getSeconds(),l=e.mongo.db;l.db("vbx_current").collection("vbxReleases").findOne({version:e.payload.version},function(c,p){var u=p.dbName;(l=l.db(u)).collection("componentSchema").findOne({_id:ObjectId(t)},function(c,p){p.hasOwnProperty("isLocked")&&p.isLocked?n(p).code(423):l.collection("componentSchemaDev").insertOne({newSchema:o,oldSchema:p.sections,schemaId:t,changeMsg:r,updatedBy:i,updatedByEmail:a,updatedOn:s,approvalStatus:"pending",sId:ObjectId(t),cId:ObjectId(p.componentId),platform:p.platform},function(o,a){if(o)return n(Boom.internal("Internal MongoDB error",o));l.collection("componentSchema").updateOne({_id:ObjectId(t)},{$set:{isLocked:!0}},{w:1},function(t,o){if(t)return n(Boom.internal("Internal MongoDB error",t));webPush.notifyAdmins(e.mongo.db,{title:"New Request in APS by "+i,message:"Commit Message : "+r}),n(o)})})})})},exports.getPropertyDetails=function(e,n){var t=e.params.propertyName,o=e.query.platform,r=e.mongo.db;r.db("vbx_current").collection("vbxReleases").findOne({version:e.query.version},function(e,i){var a=i.dbName;(r=r.db(a)).collection("propertybank").findOne({name:t,platform:o},function(e,r){if(e)return n(Boom.internal("Internal MongoDB error",e));if(console.log(t,o,r),r.title=r.title&&r.title.en?r.title.en:r.title,r.description=r.description&&r.description.en?r.description.en:r.description,r.csTitle&&(0,_keys2.default)(r.csTitle).length>0){var i=(0,_keys2.default)(r.csTitle).reduce(function(e,n){return e[n]=r.csTitle[n].en||"",e},{});r.csTitle=i}if(r.csDescription&&(0,_keys2.default)(r.csDescription).length>0){var a=(0,_keys2.default)(r.csDescription).reduce(function(e,n){return e[n]=r.csDescription[n].en||"",e},{});r.csTitle=a}n(r)})})},exports.updateProperties=function(e,n){var t=e.auth.credentials.user,o=e.mongo.db,r=e.payload.properties;o.db("vbx_current").collection("vbxReleases").findOne({version:e.payload.version},function(i,a){var c=a.dbName;o=o.db(c);var s=_.map(r,"name");o.collection("propertybankDev").find({"oldPropertyData.name":{$in:s},approvalStatus:"pending"},function(r,i){var a=[];i.each(function(r,i){if(null!=i)a.push({propId:i.propertyId,value:i.newPropertyData,name:i.oldPropertyData.name,changeMsg:i.changeMsg,changedBy:i.updatedBy,email:i.updatedByEmail});else{var c=a.length;a.length;a.forEach(function(r,i,s){r.value.isLocked=!1,o.collection("propertybank").updateOne({_id:ObjectId(r.propId)},{$set:r.value},{w:1,upsert:!0},function(r,i){if(r)return n(Boom.internal("Internal MongoDB error",r));0===--c&&o.collection("propertybankDev").updateMany({propertyId:{$in:_.map(a,"propId")}},{$set:{approvalStatus:"approved",approvedBy:t,prStatus:"pending"}},{w:1,upsert:!0},function(r,i){if(r)return n(Boom.internal("Internal MongoDB error",r));webPush.notifyUser(o,a[0].email,{title:"Request Approved ",message:"Your request has been approved in property bank by: "+t}),exports.getChangedProperties(e,n,function(e){n(e)})})})})}})})})},exports.declinePropertyChanges=function(e,n){var t=e.auth.credentials.user,o=e.mongo.db,r=e.payload.properties;o.db("vbx_current").collection("vbxReleases").findOne({version:e.payload.version},function(i,a){var c=a.dbName;o=o.db(c);var s=_.map(r,"name"),l=[];o.collection("propertybank").find({name:{$in:s}},function(r,i){i.each(function(r,i){null!=i?l.push(i._id.toString()):o.collection("propertybankDev").find({propertyId:{$in:l}},function(r,i){var a=[];i.each(function(r,i){null!=i?a.push(i.updatedByEmail):o.collection("propertybankDev").updateMany({propertyId:{$in:l},approvalStatus:"pending"},{$set:{approvalStatus:"declined",declinedBy:t}},{w:1,upsert:!0},function(r,i){if(r)return n(Boom.internal("Internal MongoDB error",r));o.collection("propertybank").updateMany({name:{$in:s},isLocked:!0},{$set:{isLocked:!1}},{w:1,upsert:!0},function(r,i){if(r)return n(Boom.internal("Internal MongoDB error",r));console.log("declined"),webPush.notifyUser(o,a[0],{title:"Request declined ",message:"Your request is declined in property bank by "+t}),exports.getChangedProperties(e,n,function(e){n(e)})})})})})})})})};var getComponentsForProperty=function(e,n,t){var o=e.mongo.db,r=[];o.db("vbx_current").collection("vbxReleases").findOne({version:e.payload.version},function(e,i){var a=i.dbName;(o=o.db(a)).collection("componentSchema").find({platform:n.platform},function(e,i){if(e)return reply(Boom.internal("Internal MongoDB error",e));i.each(function(e,i){if(null!=i&&n.platform===i.platform){var a=i.sections,c=i._id.toString(),s=i.componentId;a&&Array.isArray(a)?-1!==getProperties(a).indexOf(n.name)&&r.push({schemaId:c,componentId:s,platform:i.platform}):console.log(c)}else o.collection("components").find().toArray().then(function(e){var n=e;r.forEach(function(e,t,o){var i=_.find(n,function(n){return n._id.toString()===e.componentId});r[t].name=i.name}),t(r)})})})})};exports.updatePropertyDetails=function(e,n){var t=e.payload,o=e.mongo.db;o.db("vbx_current").collection("vbxReleases").findOne({version:e.payload.version},function(e,r){var i=r.dbName;(o=o.db(i)).collection("propertybank").findOne({_id:ObjectId(t._id)},function(e,r){if(e)return n(Boom.internal("Internal MongoDB error",e));var i={};i.category=t.category,i.defaultVal=t.defaultVal,i.description=t.description,""!==t.csDescription&&(r.csDescription?i.csDescription=r.csDescription:i.csDescription={},i.csDescription[t.componentSchemaId]=t.csDescription),i.members=t.members,i.section=t.section,i.title=t.title,""!==t.csTitle&&(r.csTitle?i.csTitle=r.csTitle:i.csTitle={},i.csTitle[t.componentSchemaId]=t.csTitle),i.type=t.type,i.value=t.value,i.configuration=t.configuration,o.collection("propertybank").updateOne({_id:ObjectId(t._id)},{$set:i},{w:1,upsert:!0},function(e,t){if(e)return n(Boom.internal("Internal MongoDB error",e));n(t)})})})},exports.updatePropertyDetailsOnDev=function(e,n){var t=e.payload,o=e.auth.credentials.user,r=e.auth.credentials._id,i=e.payload.changeMsg,a=new Date,c=a.getFullYear()+"-"+(a.getMonth()+1)+"-"+a.getDate()+" "+a.getHours()+":"+a.getMinutes()+":"+a.getSeconds(),s=e.mongo.db,l=[];t.members&&"string"!=typeof t.members&&t.members.length>0&&t.members.forEach(function(e){return l.push(e.caption)}),_promise2.default.all([translate(t.title||" ",{from:"en",to:"de"}),translate(t.description||" ",{from:"en",to:"de"}),translate(t.csTitle||" ",{from:"en",to:"de"}),translate(t.csDescription||" ",{from:"en",to:"de"}),translate(l.length>0?l:" ",{from:"en",to:"de"})]).then(function(a){var p=a[0],u=a[1],d=a[2],f=a[3],m="";l.length>0&&(m=a[4].split(",").map(function(e,n){return _extends({},t.members[n],{caption:{en:t.members[n].caption,de:e}})})),s.db("vbx_current").collection("vbxReleases").findOne({version:e.payload.version},function(a,l){var g=l.dbName;(s=s.db(g)).collection("propertybank").findOneAndUpdate({name:t.name,platform:t.platform},{$set:{isLocked:!0}},{w:1,upsert:!0},function(a,l){if(a)return n(Boom.internal("Internal MongoDB error",a));if(l=l.value){var g=JSON.parse((0,_stringify2.default)(l));delete g._id,p=g.title?g.title.en===t.title?g.title.de:p:t.title,u=g.description?g.description.en===t.description?g.description.de:u:t.description;var v={};if(v.category=t.category,v.defaultVal=[],"PBI"===t.platform){var b=t.section,y=t.componentname,h=g.defaultVal,S=[],D=!0,I="";if("formatting"==t.type)t.structuralType&&(I=(0,_keys2.default)(t.structuralType).filter(function(e){if(1==t.structuralType[e])return e}));if(h)if(h&&"object"==(void 0===h?"undefined":_typeof(h))){if(h.forEach(function(e){if(e.component==y&&e.section==b){var n={};n.component=y,n.section=b,n.value=t.defaultVal,n.title=t.title,n.description=t.description,e.formatting&&(n.formatting=I.toString()),S.push(n),D=!1}else S.push(e)}),D){var x={};x.component=y,x.section=b,x.value=t.defaultVal,x.title=t.title,x.description=t.description,"formatting"==t.type&&(x.formatting=I.toString()),S.push(x)}v.defaultVal=S}else v.defaultVal=t.defaultVal;else{var B={};B.component=y,B.section=b,B.value=t.defaultVal,B.title=t.title,B.description=t.description,"formatting"==t.type&&(B.formatting=I.toString()),S.push(B),v.defaultVal=S}var O={};"formatting"==t.type&&t.structuralType&&((0,_keys2.default)(t.structuralType).forEach(function(e){t.structuralType[e]&&(O[e]=!0)}),v.structuralType=O),v.structuralType||(v.structuralType=t.structuralType)}v.description={en:t.description,de:u},g.csDescription&&(v.csDescription=_.cloneDeep(g.csDescription)),g.csTitle&&(v.csTitle=_.cloneDeep(g.csTitle)),""!==t.csDescription?(l.csDescription?v.csDescription=_.cloneDeep(l.csDescription):v.csDescription={},g.csDescription&&g.csDescription[t.componentSchemaId]&&(f=t.csDescription===g.csDescription[t.componentSchemaId].en?g.csDescription[t.componentSchemaId].de:f),v.csDescription[t.componentSchemaId]={en:t.csDescription,de:f}):v.csDescription&&v.csDescription.hasOwnProperty(t.componentSchemaId)&&delete v.csDescription[t.componentSchemaId],g.members&&g.members.length>0&&g.members.forEach(function(e,n){e&&e.caption&&m[n]&&m[n].caption&&(m[n].caption.de=e.caption.en===m[n].caption.en?e.caption.de:m[n].caption.de)}),v.members=m||t.members,v.section="",v.title={en:t.title,de:p},""!==t.csTitle?(l.csTitle?v.csTitle=_.cloneDeep(l.csTitle):v.csTitle={},g.csTitle&&g.csTitle[t.componentSchemaId]&&(d=t.csTitle===g.csTitle[t.componentSchemaId].en?g.csTitle[t.componentSchemaId].de:d),v.csTitle[t.componentSchemaId]={en:t.csTitle,de:d}):v.csTitle&&v.csTitle.hasOwnProperty(t.componentSchemaId)&&delete v.csTitle[t.componentSchemaId],v.type=t.type,v.value=t.value,v.configuration=t.configuration,s.collection("propertybankDev").insertOne({propertyId:l._id.toString(),oldPropertyData:g,newPropertyData:v,updatedBy:o,updatedByEmail:r,updatedOn:c,changeMsg:i,approvalStatus:"pending",platform:g.platform},function(t,r){if(t)return n(Boom.internal("Internal MongoDB error",t));console.log("Here"),webPush.notifyAdmins(e.mongo.db,{title:"New Request in PropertyBank by "+o,message:"Commit Message : "+i}),n(r)})}})})}).catch(function(e){console.log(e),n(e.toString())})},exports.addProperty=function(e,n){var t=e.payload,o=t.name,r=e.mongo.db;r.db("vbx_current").collection("vbxReleases").findOne({version:e.payload.version},function(e,i){var a=i.dbName;(r=r.db(a)).collection("propertybank").findOne({name:o,platform:t.platform},function(e,i){if(e)return n(Boom.internal("Internal MongoDB error",e));i?n(i).code(303):r.collection("propertybank").insertOne({name:o,platform:t.platform},function(e,t){console.log("Inserted a document into the propertybank collection."),n(t).code(201)})})})},exports.getChangedComponents=function(e,n,t){var o=e.mongo.db,r="",i="";e.query.contribution||e.payload&&e.payload.contribution?(r="componentProperties",i="componentPropertiesDev"):(r="componentSchema",i="componentSchemaDev"),o.db("vbx_current").collection("vbxReleases").findOne({version:e.query.version?e.query.version:e.payload.version},function(e,a){var c=a.dbName;o=o.db(c);var s,l=[],p=0;s=function(){l.forEach(function(e,r){var a,c,s,u,d,f=e.componentId,m=e.schemaId;c=r,s=f,u=m,d=function(){0===p&&(t?t(l):n(l))},p++,(a=o).collection("components").findOne({_id:ObjectId(s)},function(e,n){a.collection(i).findOne({schemaId:u,approvalStatus:"pending"},function(t,o){p--,e?(console.log(e),d()):(l[c].name=n.name,o&&(l[c].lockedBy=o.updatedBy),d())})})}),0===p&&(t?t(l):n(l))},o.collection(r).find({isLocked:!0}).each(function(e,n){null!=n?l.push({componentId:n.componentId,schemaId:n._id.toString()}):s()})})},exports.getChangedProperties=function(e,n,t){var o=e.mongo.db;o.db("vbx_current").collection("vbxReleases").findOne({version:e.query.version?e.query.version:e.payload.version},function(e,r){var i=r.dbName,a=[];(o=o.db(i)).collection("propertybankDev").find({approvalStatus:"pending"}).each(function(e,o){null!=o?a.push(o):t?t({lockedProperties:a}):n({lockedProperties:a})})})},exports.getSchemaChanges=function(e,n,t){var o=JSON.parse(e.query.component),r=e.mongo.db;r.db("vbx_current").collection("vbxReleases").findOne({version:e.query.version},function(e,i){var a=i.dbName;(r=r.db(a)).collection("componentSchemaDev").findOne({schemaId:o.schemaId,approvalStatus:"pending"},function(e,o){t?t(o):n(o)})})},exports.declineSchemaChanges=function(e,n){var t=e.payload.component,o=e.auth.credentials.user,r=new Date,i=r.getFullYear()+"-"+(r.getMonth()+1)+"-"+r.getDate()+" "+r.getHours()+":"+r.getMinutes()+":"+r.getSeconds(),a=e.mongo.db;a.db("vbx_current").collection("vbxReleases").findOne({version:e.payload.version},function(r,c){var s=c.dbName;(a=a.db(s)).collection("componentSchemaDev").findOne({schemaId:t.schemaId,approvalStatus:"pending"},function(r,c){c.updatedBy.toLowerCase()===o.toLowerCase()||-1!==e.auth.credentials.scope.indexOf("ADMIN")?a.collection("componentSchemaDev").findOneAndUpdate({schemaId:t.schemaId,approvalStatus:"pending"},{$set:{declinedBy:o,approvalStatus:"declined",declinedOn:i}},{w:1,upsert:!0},function(r,i){if(r)return n(Boom.internal("Internal MongoDB error",r));a.collection("componentSchema").findOneAndUpdate({_id:ObjectId(t.schemaId)},{$set:{isLocked:!1}},{w:1,upsert:!0},function(t,r){console.log(r.value),webPush.notifyUser(a,i.value.updatedByEmail,{title:"Your request has been declined by: "+o,message:"Commit Message : "+i.value.changeMsg}),exports.getChangedComponents(e,n,function(e){n({lockedComponents:e,oldTreeData:i.value.oldSchema})})})}):n("Illegal access").code(401)})})},exports.approveSchemaChanges=function(e,n){var t=e.payload.component,o=e.auth.credentials.user,r=new Date,i=r.getFullYear()+"-"+(r.getMonth()+1)+"-"+r.getDate()+" "+r.getHours()+":"+r.getMinutes()+":"+r.getSeconds(),a=e.mongo.db;a.db("vbx_current").collection("vbxReleases").findOne({version:e.payload.version},function(r,c){var s=c.dbName;(a=a.db(s)).collection("componentSchemaDev").findOne({schemaId:t.schemaId,approvalStatus:"pending"},function(r,c){return r?n(Boom.internal("Internal MongoDB error",r)):c.newSchema?void a.collection("componentSchema").updateOne({_id:ObjectId(t.schemaId)},{$set:{sections:c.newSchema,isLocked:!1}},{w:1,upsert:!0},function(r,s){if(r)return n(Boom.internal("Internal MongoDB error",r));a.collection("componentSchemaDev").findOneAndUpdate({schemaId:t.schemaId,approvalStatus:"pending"},{$set:{approvedBy:o,approvalStatus:"approved",approvedOn:i,prStatus:"pending"}},{w:1,upsert:!0},function(t,r){if(webPush.notifyUser(a,r.value.updatedByEmail,{title:"Your request has been approved by: "+o,message:"Commit Message : "+r.value.changeMsg}),t)return n(Boom.internal("Internal MongoDB error",t));exports.getChangedComponents(e,n,function(e){var t,o,r,i,s,l=(t=c.newSchema,o=[],r=[],i=[],s=[],function e(n,t){t.forEach(function(t){"sections"===n&&o.push(t.name),"subsections"===n&&r.push(t.name),"groups"===n&&i.push(t.name),"properties"===n&&s.push(t),t.hasOwnProperty("subsections")?e("subsections",t.subsections):t.hasOwnProperty("group")?e("groups",t.group):t.hasOwnProperty("properties")&&e("properties",t.properties)})}("sections",t),{sections:o,subsections:r,groups:i,properties:s});a.collection("menuData").find(function(t,o){o.toArray().then(function(t){t=t.map(function(e){return e.name}),l=[].concat(l.sections||[]).concat(l.subsections||[]).concat(l.groups||[]),l=_.filter(l,function(e){return""!==e});var o=_.difference(l,t);o.length>0?translate(o,{from:"en",to:"de"}).then(function(t){var r=(t=t.split(",")).map(function(e,n){return{name:o[n],en:o[n],de:e}});a.collection("menuData").insertMany(r,function(t,o){n(e)})}):n(e)})})})})}):n(Boom.internal("No schema found",r))})})},exports.previewChanges=function(e,n){var t=void 0,o=void 0,r=void 0,i=require("./generateHtmlForPreview").generateHtml,a=e.mongo.db;a.db("vbx_current").collection("vbxReleases").findOne({version:e.query.version?e.query.version:e.payload.version},function(c,s){var l=s.dbName;a=a.db(l),"get"===e.method?(t=JSON.parse(e.query.component),r=e.query.type,i(a,t,"html",r,null,"prod",function(e,t){n(t)})):(t=e.payload.component,o=e.payload.schema,i(a,t,"html",r,o,"prod",function(e,t){n(t)}))})},exports.getVersions=function(e,n){var t=[];e.mongo.db.db("vbx_current").collection("vbxReleases").find().each(function(e,o){null!=o?t.push(o):n(t)})},exports.createVersionStash=function(e,n){var t=e.mongo.db,o=e.payload.version.replace(".",""),r=e.payload.branchName,i=(new Date).toString("dd/mm/yyyy hh:MM:ss"),a=e.auth.credentials.user,c="vbx_"+o,s={copydb:1,fromhost:config.get("serverConfig.host"),fromdb:"vbx_current",todb:c};t.admin().command(s,function(o,s){o?n(o.errmsg):t.db("vbx_current").collection("vbxReleases").insertOne({version:e.payload.version,dbName:c,branchName:r,createdAt:i,createdBy:a},function(e,t){n(e||t)})})},exports.generatePR=function(e,n){var t=e.mongo.db,o=require("./generateHtmlForPreview").generateHtml,r=[],i=[],a=[],c=[],s=function(e,n,t){o(e,n,"file","new",null,"dev",function(e,n){t(null)})},l=function(e,n){var o="**Relevant Changes:**\n",r=d3.queue();e=_.uniqBy(e,function(e){return e.name.concat(e.platform)});var i=_.filter(e,function(e){return"VBX"===e.platform}),a=_.filter(e,function(e){return"PBI"===e.platform}),c=a.reduce(function(e,n,t,o){return e.push(ObjectId(n.componentId)),e},[]),l=function(e){var n=e.toLowerCase().replace(/[^A-Za-z0-9]/g," ").split(" ").reduce(function(e,n){return e+p(n.toLowerCase())});return n.charAt(0).toLowerCase()+n.slice(1)},p=function(e){return e.charAt(0).toUpperCase()+e.toLowerCase().slice(1)},u=function(e){new _promise2.default(function(e,n){t.collection("components").aggregate([{$lookup:{from:"componentSchema",localField:"_id",foreignField:"cId",as:"schemaDetails"}},{$unwind:"$schemaDetails"}],function(t,o){t&&n("Internal MongoDB error"),e(o)})}).then(function(n){var o={};t.collection("propertybank").find({platform:"VBX"},function(r,i){i.toArray().then(function(r){r.forEach(function(e){"dynamic"!==e.type&&(e.csTitle&&(0,_keys2.default)(e.csTitle).length>0&&(0,_keys2.default)(e.csTitle).forEach(function(t){if(_.find(n,function(e){return e.schemaDetails._id.toString()===t})){var r=_.find(n,function(e){return e.schemaDetails._id.toString()===t}).name;o[r]||(o[r]={}),o[r][e.name]=e.title.de||""}}),e.csDescription&&(0,_keys2.default)(e.csDescription).length>0&&(0,_keys2.default)(e.csDescription).forEach(function(t){if(_.find(n,function(e){return e.schemaDetails._id.toString()===t})){var r=_.find(n,function(e){return e.schemaDetails._id.toString()===t}).name;o[r]||(o[r]={}),o[r][e.name+"_desc"]=e.description.de||""}}),o.default||(o.default={}),e.members&&"string"!=typeof e.members&&e.members.length>0&&e.members.forEach(function(e){o.default[e.name+"_member"]=e.caption.de||""}),o.default[e.name]=e.title&&e.title.de?e.title.de:"",o.default[e.name+"_desc"]=e.description&&e.description.de?e.description.de:"")}),t.collection("menuData").find(function(n,t){t.toArray().then(function(n){n.forEach(function(e){o.default||(o.default={}),o.default[e.name]=e.de}),fs.writeFile(config.get("application.localeLocation")+"/de.js","var deLanguagePack = "+(0,_stringify2.default)(o,null,4)+";",function(n){n?(console.log("locale file write error"),e(null)):(console.log("locale generated"),e(null))})}).catch(function(e){console.log(e.stack)})})}).catch(function(e){console.log(e.stack)})})}).catch(function(e){console.log(e.stack)})};r.defer(function(e){c.length>0?simpleGitPBI.checkout("aps-tool").pull("upstream","master",{"--no-edit":null},function(){t.collection("propertybank").find({platform:"PBI"},function(n,o){o.toArray().then(function(n){var o,r,i;o=n,r=function(){var n=[];n.push("**Relevant Changes:**"),a.forEach(function(e){n.push("**Capabilities -** "+e.changeMsg+" `"+e._id.toString()+"`")}),simpleGitPBI.add("./*").commit(n,function(t){t?console.log("PBI - failed to commit #"):console.log("PBI Commited successfully"),e(null,{platform:"PBI",body:n.join("\n")})})},i={bool:"boolean",enumeration:"string",fill:"string","formatting.fontSize":"number","formatting.alignment":"string","formatting.labelDisplayUnits":"number",numeric:"number",integer:"number",text:"string"},t.collection("componentSchema").aggregate([{$match:{cId:{$in:c}}},{$lookup:{from:"components",localField:"cId",foreignField:"_id",as:"componentDetails"}},{$unwind:"$componentDetails"}],function(e,n){c.forEach(function(e){var t={},r=_.cloneDeep(_.find(n,function(n){return n.cId.toString()===e.toString()})),a=r.componentDetails.name,c=[],s=[];r.sections.forEach(function(e){s.push("public "+l(e.name)+" = new "+l(e.name)+"();"),t[l(e.name)]={displayName:e.name},c.push("export class "+e.name+" {");var n=e.name;if(e.properties){var r=e.properties.reduce(function(e,t){var r=_.cloneDeep(_.find(o,{name:t})),s="",l=(r=_.pick(r,["name","type","members","structuralType","defaultVal"])).type,p=void 0;"formatting"==l&&r.defaultVal&&(p=r.defaultVal.filter(function(e){return e.section==n&&e.component==a}))&&p[0]&&p[0].formatting&&(s=p[0].formatting.toString());var u=i[l];if(_.isEmpty(s)||(u=i[l+"."+s],r.type={},r.type[l]={},r.type[l][s]=!0),r.description?r.description=r.description.en?r.description.en:r.description:r.description="",r.displayName=r.name,r.type||(r.type={},r.type[l]=!0),"enumeration"===l){var d=r.members.map(function(e){return{displayName:e.caption.en?e.caption.en:e.caption,value:e.name}});r.type={},r.type[l]=d}var f="",m=r.defaultVal;if(m)if("object"!=(void 0===m?"undefined":_typeof(m)))f=m.toString();else{var g=m.filter(function(e){return e.section==n&&e.component==a});_.isEmpty(g)?f="":(f=g[0].value,r.description=g[0].description)}return"string"===u&&(f='"'+f+'"'),c.push("public "+t+": "+u+" = "+f+";"),r=_.omit(r,["name","members","structuralType","defaultVal"]),e[t]=r,e},{});t[l(e.name)].properties=r}c.push("}")});var p=_.find(n,function(n){return n.cId.toString()===e.toString()}).componentDetails.name,u=config.get("application.pbiSourceLocation")+"/"+p+"/",d=void 0;fs.readdirSync(u).forEach(function(e){var n=""+u+e;if(fs.statSync(n).isDirectory())fs.readdirSync(n).forEach(function(e){return fs.existsSync(n+"/pbiviz.json")?(d=n,!1):!d&&void 0});else if("pbiviz.json"===e)return d=u,!1;if(d)return!1});var f=s.join("\r\n"),m=c.join("\r\n"),g=fs.readFileSync(d+"/capabilities.json"),v=JSON.parse(g);v.objects=t,fs.writeFileSync(d+"/capabilities.json",stringify(v,{space:4}));var b=fs.readFileSync("./settings.template.ts"),y=Handlebars.compile(b.toString(),{noEscape:!0}),h=d+"/src/settings.ts";fs.writeFileSync(h,y({visualSettings:f,groupClasses:m}))}),r(null)})}).catch(function(e){console.log(e.stack)})})}):e(null)}),r.defer(function(e){var n=d3.queue();simpleGit.checkout("aps-tool").pull("upstream","master",{"--no-edit":null},function(){i.forEach(function(e){o+="**Schema -** "+e.changeMsg+" `"+e._id.toString()+"`\n"}),n.defer(s,t,i),n.defer(u),n.awaitAll(function(n){if(n)throw n;e(null,{platform:"VBX",body:o})})})}),r.awaitAll(function(e,t){n(null,t)})},p=function(n,t){getComponentsForProperty(e,n,function(e){var o=_.map(e,function(e){return _.assignIn(e,{changeMsg:n.changeMsg},{updatedBy:n.updatedBy},{_id:n._id})}),r=[].concat(o);t(null,r)})};t.db("vbx_current").collection("vbxReleases").findOne({version:e.payload.version},function(e,o){var s=o.dbName,u=[];(t=t.db(s)).collection("propertybankDev").aggregate([{$match:{prStatus:"pending"}},{$project:{"oldPropertyData.name":!0,changeMsg:!0,updatedBy:!0,platform:!0}}],function(e,o){if(e)return n(e.toString());o.forEach(function(e){u.push({name:e.oldPropertyData.name,changeMsg:e.changeMsg,updatedBy:e.updatedBy,_id:e._id.toString(),platform:e.platform}),"VBX"===e.platform?a.push(e._id):c.push(e._id)});var s=d3.queue();(u=_.uniqBy(u,function(e){return e.name.concat(e.platform)})).forEach(function(e,n,t){s.defer(p,e)}),s.awaitAll(function(e,o){if(e)throw e;var a,c;a=function(e){d3.queue().defer(l,[].concat.apply([],o).concat(e)).await(function(e,t){if(e)throw e;n("value")})},c=[],t.collection("componentSchemaDev").aggregate([{$match:{sId:{$exists:!0},prStatus:"pending"}},{$lookup:{from:"componentSchema",localField:"sId",foreignField:"_id",as:"schemaDetails"}},{$unwind:"$schemaDetails"},{$lookup:{from:"components",localField:"cId",foreignField:"_id",as:"componentDetails"}},{$unwind:"$componentDetails"}],function(e,t){if(e)return n(e.toString());t.forEach(function(e){c.push({schemaId:e.schemaDetails._id.toString(),name:e.componentDetails.name,updatedBy:e.updatedBy,changeMsg:e.changeMsg,_id:e._id.toString(),platform:e.platform,componentId:e.cId.toString()}),"VBX"===e.platform?r.push(e._id):i.push(e._id)}),a(c)})})})})};var getProperties=function e(n,t){var o=[];return n.forEach(function(n,t,r){if(n.hasOwnProperty("properties"))n.properties.forEach(function(e,n,t){o.push(e)});else for(var i in n){if(Array.isArray(n[i]))e(n[i]).forEach(function(e,n,t){o.push(e)})}}),o},getPropertiesForPBI=function(e,n,t,o){var r=[],i=[],a=[];return n.hasOwnProperty("objects")&&(i=n.objects),(0,_keys2.default)(i).forEach(function(n,o,c){if(i[n].hasOwnProperty("properties")){a=i[n].properties;var s="public "+n.toString()+" = new (.*?)\\(\\);",l=new RegExp(s,"gm").exec(t)[1],p="export class "+l.toString()+" {(.|\\r\\n|\\n)*?}\\\\r\\\\n",u=new RegExp(p),d="";null!=u.exec(t)?d=u.exec(t).toString():(p="export class "+l.toString()+" {(.|\\r\\n|\\n)*?}",d=(u=new RegExp(p)).exec(t).toString());var f=d.replace("/","").replace("\\","");(0,_keys2.default)(a).forEach(function(t,o,i){var c={members:[]},s=a[t].type,l=void 0,p=void 0,u=a[t].description?a[t].description:"",d=a[t].displayName;"object"==(void 0===s?"undefined":_typeof(s))?(l=(0,_keys2.default)(s)[0],p=s[l]):l=s;var m=new RegExp("public "+t+":(.*?)=(.*?);").exec(f),g=m[2];"string"===m[1].trim().toLowerCase()&&(g=(g=(g=(g=g.trim()).replace(/\\\"/g,'"')).replace(/\\\'/g,"'")).substr(1,g.length-2)),g=g.trim(),"number"===m[1].trim().toLowerCase()&&(g=parseInt(g)),"true"==g?g=!0:"false"==g&&(g=!1);var v=r.find(function(e){return e.name===t});if(v){var b="";if(a[t].type.formatting){var y=a[t].type.formatting;b=(0,_keys2.default)(y).filter(function(e){if(1==y[e])return e}).toString(),v.defaultVal.push({component:e,section:n,value:g,title:d,description:u,formatting:b})}else v.defaultVal.push({component:e,section:n,value:g,title:d,description:u})}else{"enumeration"==l?(0,_keys2.default)(p).forEach(function(e,n){var t=p[e],o={caption:t.displayName.toString(),name:t.value};c.members.push(o)}):"fill"!=l&&"formatting"!=l||(c.structuralType=p),c.name=t.toString(),c.platform="PBI",c.isLocked=!1,c.category="",c.configuration={},c.csDescription={},c.defaultVal=[];var h="";c.structuralType&&"formatting"==l?(h=(0,_keys2.default)(c.structuralType).filter(function(e){if(1==c.structuralType[e])return e}),c.defaultVal.push({component:e,section:n,value:g,title:d,description:u,formatting:h.toString()})):c.defaultVal.push({component:e,section:n,value:g,title:d,description:u}),c.description="",c.members||(c.members=[]),c.section="",c.structuralType||(c.structuralType={}),c.type=l.toString(),c.value="",c.title=a[t].displayName,r.push(c)}})}}),r},getComponentSchemaForPBI=function(e){var n=[],t=e.objects;return(0,_keys2.default)(t).forEach(function(e,o,r){var i={};i.name=e.toString();var a=t[e].properties,c=[];(0,_keys2.default)(a).forEach(function(e,n,t){c.push(e.toString())}),i.properties=c,n.push(i)}),n};exports.analyzeSchema=function(e,n,t){var o=e.mongo.db,r=e.payload.schema,i=e.payload.platform,a=e.payload.componentName,c=[],s=[],l=[];if("VBX"==i)c=getProperties(r),o.db("vbx_current").collection("vbxReleases").findOne({version:e.payload.version},function(e,r){var a=r.dbName,l=c.length,p=c.length;o=o.db(a);c.length>0?c.forEach(function(e,r,a){var c;c=e,o.collection("propertybank").findOne({name:c,platform:i},function(e,o){p--,o||s.push(c),0===p&&(t?t({newProperties:s,totalProperties:l}):n({newProperties:s,totalProperties:l}))})}):t?t({newProperties:[],totalProperties:0}):n({newProperties:[],totalProperties:0})});else{var p=e.payload.settingsTsFile;c=getPropertiesForPBI(a,r,p),o.db("vbx_current").collection("vbxReleases").findOne({version:e.payload.version},function(e,r){var a=r.dbName,p=c.length,u=c.length;o=o.db(a);c.length>0?c.forEach(function(e,r,a){var c;c=e,o.collection("propertybank").findOne({name:c.name,platform:i},function(e,o){u--,o?(c.defaultVal.forEach(function(e){o.defaultVal.push(e)}),l.push(o)):s.push(c),0===u&&(t?t({newProperties:s,totalProperties:p,propertiesTobeUpdated:l}):n({newProperties:s,totalProperties:p,propertiesTobeUpdated:l}))})}):t?t({newProperties:[],totalProperties:0}):n({newProperties:[],totalProperties:0})})}},exports.createComponent=function(e,n){var t=e.mongo.db,o=e.payload.schema,r=e.payload.componentName,i=e.payload.platform;exports.analyzeSchema(e,n,function(a){var c=a.newProperties,s=[];if("PBI"==i){var l=getComponentSchemaForPBI(o),p=a.propertiesTobeUpdated;c.forEach(function(e,n,t){s.push({name:e.name,platform:e.platform,isLocked:e.isLocked,category:e.category,configuration:e.configuration,csDescription:e.csDescription,defaultVal:e.defaultVal,description:e.description,members:e.members,section:e.section,structuralType:e.structuralType,title:e.title,type:e.type,value:e.value})}),t.db("vbx_current").collection("vbxReleases").findOne({version:e.payload.version},function(e,o){var a=o.dbName;(t=t.db(a)).collection("components").findOne({name:r,platform:i},function(e,o){o?n(o).code(303):t.collection("propertybank").insertMany(s,function(e,o){t.collection("components").insertOne({name:r,platform:i},function(e,r){t.collection("componentSchema").insertOne({sections:l,componentId:r.insertedId.toString(),cId:r.insertedId,platform:i,isLocked:!1},function(e,t){n(o).code(201)})})})});try{_.isEmpty(p)||p.forEach(function(e){t.collection("propertybank").updateOne({_id:ObjectId(e._id)},{$set:{defaultVal:e.defaultVal}},{w:1,upsert:!0},function(e,t){if(e)return n(Boom.internal("Internal MongoDB error",e));n(t)})})}catch(e){n(e.toString())}})}else t.db("vbx_current").collection("vbxReleases").findOne({version:e.payload.version},function(e,a){var l=a.dbName;t=t.db(l),c.forEach(function(e,n,t){s.push({name:e,platform:i})}),t.collection("components").findOne({name:r,platform:i},function(e,a){a?n(a).code(303):t.collection("propertybank").insertMany(s,function(e,a){t.collection("components").insertOne({name:r,platform:i},function(e,r){t.collection("componentSchema").insertOne({sections:o,componentId:r.insertedId.toString(),cId:r.insertedId,platform:i},function(e,t){n(a).code(201)})})})})})})},exports.getPendingApproval=function(e,n){var t=e.mongo.db;t.db("vbx_current").collection("vbxReleases").findOne({version:e.query.version},function(e,o){var r=o.dbName;(t=t.db(r)).collection("componentSchemaDev").find({approvalStatus:"pending"},function(e,o){if(e)return n(Boom.internal("Internal MongoDB error",e));o.toArray().then(function(e){var o=e;t.collection("propertybankDev").find({approvalStatus:"pending"},function(e,t){if(e)return n(Boom.internal("Internal MongoDB error",e));t.toArray().then(function(e){n({schemaChanges:o,propChange:e})})})})})})},exports.getPendingPR=function(e,n){var t=e.mongo.db;t.db("vbx_current").collection("vbxReleases").findOne({version:e.query.version},function(e,o){var r=o.dbName;(t=t.db(r)).collection("componentSchemaDev").find({prStatus:"pending"},function(e,o){if(e)return n(Boom.internal("Internal MongoDB error",e));o.toArray().then(function(e){var o=e;t.collection("propertybankDev").find({prStatus:"pending"},function(e,t){if(e)return n(Boom.internal("Internal MongoDB error",e));t.toArray().then(function(e){n({schemaChanges:o,propChange:e})})})})})})},exports.generateAll=function(e,n){var t=e.mongo.db,o=require("./generateHtmlForPreview").generateHtml;t.db("vbx_current").collection("vbxReleases").findOne({version:e.payload.version},function(e,r){var i=r.dbName;(t=t.db(i)).collection("components").find(function(e,r){r.toArray().then(function(e){var r=e,i=r.length;r.forEach(function(e,a){t.collection("componentSchema").findOne({componentId:e._id.toString()},function(c,s){c?console.log(e._id.toString()):r[a].schemaId=s._id.toString(),0===--i&&function(e){e.length;simpleGit.checkout("aps-tool").pull("upstream","master",{"--no-edit":null},function(){o(t,e,"file","new",null,"prod",function(e,t){simpleGit.add("./*").commit("**APS-TOOL** - Generate All",function(e){e?console.log("failed to commit for Generate All"):console.log("Commited successfully"),n("Generated all HTML files")})})})}(r)})})})})})},exports.getCSData=function(e,n){var t=e.mongo.db;t.db("vbx_current").collection("vbxReleases").findOne({version:e.query.version},function(e,o){var r=o.dbName;(t=t.db(r)).collection("components").aggregate([{$lookup:{from:"componentSchema",localField:"_id",foreignField:"cId",as:"schemaDetails"}},{$unwind:"$schemaDetails"}],function(e,o){if(e)return n(e.toString());t.collection("propertybank").find(function(e,t){var r=[];t.toArray().then(function(e){d3.queue();e.forEach(function(e){var n=null;e.csTitle&&(n=e.csTitle,(0,_keys2.default)(n).forEach(function(t){var i={name:e.name,baseTitle:e.title,componentName:_.find(o,function(e){return e.schemaDetails._id.toString()===t}).name,csTitle:n[t]};e.csDescription&&e.csDescription.hasOwnProperty(t)&&(i.csDescription=e.csDescription[t],i.baseDescription=e.description),r.push(i)}))}),n((0,_stringify2.default)(r))})})})})},exports.repairCS=function(e,n){var t=e.mongo.db;t.db("vbx_current").collection("vbxReleases").findOne({version:e.payload.version},function(e,o){var r=o.dbName;(t=t.db(r)).collection("components").aggregate([{$lookup:{from:"componentSchema",localField:"_id",foreignField:"cId",as:"schemaDetails"}},{$unwind:"$schemaDetails"}],function(e,o){if(e)return n(e.toString());t.collection("propertybank").find(function(e,o){o.toArray().then(function(e){var o=d3.queue(),r=function(o,r,i,a){var c={};r&&(c.csTitle=r),i&&(c.csDescription=i),_.isEmpty(c)?a(null,e):t.collection("propertybank").updateOne({_id:o},{$set:c},{w:1},function(e,t){if(e)return console.log(e),n(Boom.internal("Internal MongoDB error",e));a(null,t)})};e.forEach(function(e){var n=null,t=null;e.csTitle&&(t=e.csTitle,(0,_keys2.default)(t).forEach(function(n){e.title!==t[n]&&t[n]||delete t[n]})),e.csDescription&&(n=e.csDescription,(0,_keys2.default)(n).forEach(function(t){e.description!==n[t]&&n[t]||delete n[t]})),(t||n)&&o.defer(r,e._id,t,n)}),o.awaitAll(function(e,t){if(e)throw e;n("Updated successfully")})})})})})},exports.repairCompSchema=function(e,n){var t=e.mongo.db;t.db("vbx_current").collection("vbxReleases").findOne({version:e.payload.version},function(e,n){var o=n.dbName;(t=t.db(o)).collection("componentSchema").find().forEach(function(e){t.collection("componentSchema").update({_id:e._id},{$set:{cId:ObjectId(e.componentId)}})})})};