"use strict";var _from=require("babel-runtime/core-js/array/from"),_from2=_interopRequireDefault(_from),_iterator=require("babel-runtime/core-js/symbol/iterator"),_iterator2=_interopRequireDefault(_iterator),_symbol=require("babel-runtime/core-js/symbol"),_symbol2=_interopRequireDefault(_symbol),_assign=require("babel-runtime/core-js/object/assign"),_assign2=_interopRequireDefault(_assign),_stringify=require("babel-runtime/core-js/json/stringify"),_stringify2=_interopRequireDefault(_stringify),_promise=require("babel-runtime/core-js/promise"),_promise2=_interopRequireDefault(_promise),_keys=require("babel-runtime/core-js/object/keys"),_keys2=_interopRequireDefault(_keys),_typeof="function"==typeof _symbol2.default&&"symbol"==typeof _iterator2.default?function(e){return typeof e}:function(e){return e&&"function"==typeof _symbol2.default&&e.constructor===_symbol2.default&&e!==_symbol2.default.prototype?"symbol":typeof e},_extends=_assign2.default||function(e){for(var n=1;n<arguments.length;n++){var t=arguments[n];for(var o in t)Object.prototype.hasOwnProperty.call(t,o)&&(e[o]=t[o])}return e};function _interopRequireDefault(e){return e&&e.__esModule?e:{default:e}}function _toConsumableArray(e){if(Array.isArray(e)){for(var n=0,t=Array(e.length);n<e.length;n++)t[n]=e[n];return t}return(0,_from2.default)(e)}var path=require("path"),Boom=require("boom"),ObjectId=require("mongodb").ObjectId,fs=require("fs"),config=require("config"),webPush=require("./lib/webPush"),simpleGit=require("simple-git")(config.get("application.dsxSourceLocation")).addConfig("user.name",config.get("application.gitUser")).addConfig("user.email",config.get("application.gitEmail")),simpleGitPBI=require("simple-git")(config.get("application.pbiSourceLocation")).addConfig("user.name",config.get("application.gitUser")).addConfig("user.email",config.get("application.gitEmail")),axios=require("axios"),_=require("lodash"),d3=require("d3-queue"),stringify=require("json-stable-stringify"),Handlebars=require("handlebars"),_require=require("perf_hooks"),performance=_require.performance,prettier=require("prettier"),translate=require("translate");translate.engine="yandex",translate.key="trnsl.1.1.20180614T121111Z.0199abeacac8da58.dc0200799ded65a9ba3309c2c6c10f0e47faf9a0",exports.getComponents=function(o,r){var i=o.mongo.db;i.db("vbx_current").collection("vbxReleases").findOne({version:o.query.version},function(e,n){var t=n.dbName;(i=i.db(t)).collection("components").find(function(e,n){if(e)return r(Boom.internal("Internal MongoDB error",e));n.toArray().then(function(n){exports.getChangedComponents(o,r,function(e){r({componentList:n,lockedComponents:e})})})})})},exports.getProperties=function(e,o){var r=e.mongo.db,i=e.query.platform||"VBX";r.db("vbx_current").collection("vbxReleases").findOne({version:e.query.version},function(e,n){var t=n.dbName;(r=r.db(t)).collection("propertybank").find({platform:i},function(e,n){if(e)return o(Boom.internal("Internal MongoDB error",e));n.toArray().then(function(e){o(e)})})})},exports.getComponent=function(r,i){var o=r.params.componentId,a=r.mongo.db;a.db("vbx_current").collection("vbxReleases").findOne({version:r.query.version},function(e,n){var t=n.dbName;(a=a.db(t)).collection("componentSchema").findOne({componentId:o},function(e,n){if(e)return i(Boom.internal("Internal MongoDB error",e));var t=n.componentId,o=n._id.toString();r.query.schemaVersion&&"dev"===r.query.schemaVersion&&n.hasOwnProperty("isLocked")&&n.isLocked?a.collection("componentSchemaDev").findOne({schemaId:n._id.toString(),approvalStatus:"pending"},function(e,n){i({_id:o,componentId:t,sections:n.newSchema})}):i(n)})})},exports.updateComponent=function(e,o){var r=e.payload.schemaId,i=e.payload.sections,a=e.mongo.db;a.db("vbx_current").collection("vbxReleases").findOne({version:e.payload.version},function(e,n){var t=n.dbName;(a=a.db(t)).collection("componentSchema").updateOne({_id:ObjectId(r)},{$set:{sections:i}},{w:1},function(e,n){if(e)return o(Boom.internal("Internal MongoDB error",e));o(n)})})},exports.updateComponentOnDev=function(o,r){var i=o.payload.schemaId,a=o.payload.sections,c=o.payload.changeMsg,s=o.auth.credentials.user,l=o.auth.credentials._id,e=new Date,p=e.getFullYear()+"-"+(e.getMonth()+1)+"-"+e.getDate()+" "+e.getHours()+":"+e.getMinutes()+":"+e.getSeconds(),u=o.mongo.db;u.db("vbx_current").collection("vbxReleases").findOne({version:o.payload.version},function(e,n){var t=n.dbName;(u=u.db(t)).collection("componentSchema").findOne({_id:ObjectId(i)},function(e,n){n.hasOwnProperty("isLocked")&&n.isLocked?r(n).code(423):u.collection("componentSchemaDev").insertOne({newSchema:a,oldSchema:n.sections,schemaId:i,changeMsg:c,updatedBy:s,updatedByEmail:l,updatedOn:p,approvalStatus:"pending",sId:ObjectId(i),cId:ObjectId(n.componentId),platform:n.platform},function(e,n){if(e)return r(Boom.internal("Internal MongoDB error",e));u.collection("componentSchema").updateOne({_id:ObjectId(i)},{$set:{isLocked:!0}},{w:1},function(e,n){if(e)return r(Boom.internal("Internal MongoDB error",e));webPush.notifyAdmins(o.mongo.db,{title:"New Request in APS by "+s,message:"Commit Message : "+c}),r(n)})})})})},exports.getPropertyDetails=function(e,r){var i=e.params.propertyName,a=e.query.platform,o=e.mongo.db;o.db("vbx_current").collection("vbxReleases").findOne({version:e.query.version},function(e,n){var t=n.dbName;(o=o.db(t)).collection("propertybank").findOne({name:i,platform:a},function(e,t){if(e)return r(Boom.internal("Internal MongoDB error",e));if(console.log(i,a,t),t.title=t.title&&t.title.en?t.title.en:t.title,t.description=t.description&&t.description.en?t.description.en:t.description,t.csTitle&&0<(0,_keys2.default)(t.csTitle).length){var n=(0,_keys2.default)(t.csTitle).reduce(function(e,n){return e[n]=t.csTitle[n].en||"",e},{});t.csTitle=n}if(t.csDescription&&0<(0,_keys2.default)(t.csDescription).length){var o=(0,_keys2.default)(t.csDescription).reduce(function(e,n){return e[n]=t.csDescription[n].en||"",e},{});t.csTitle=o}r(t)})})},exports.updateProperties=function(i,a){var c=i.auth.credentials.user,s=i.mongo.db,r=i.payload.properties;s.db("vbx_current").collection("vbxReleases").findOne({version:i.payload.version},function(e,n){var t=n.dbName;s=s.db(t);var o=_.map(r,"name");s.collection("propertybankDev").find({"oldPropertyData.name":{$in:o},approvalStatus:"pending"},function(e,n){var r=[];n.each(function(e,n){if(null!=n)r.push({propId:n.propertyId,value:n.newPropertyData,name:n.oldPropertyData.name,changeMsg:n.changeMsg,changedBy:n.updatedBy,email:n.updatedByEmail});else{var o=r.length;r.length;r.forEach(function(e,n,t){e.value.isLocked=!1,s.collection("propertybank").updateOne({_id:ObjectId(e.propId)},{$set:e.value},{w:1,upsert:!0},function(e,n){if(e)return a(Boom.internal("Internal MongoDB error",e));0===--o&&s.collection("propertybankDev").updateMany({propertyId:{$in:_.map(r,"propId")}},{$set:{approvalStatus:"approved",approvedBy:c,prStatus:"pending"}},{w:1,upsert:!0},function(e,n){if(e)return a(Boom.internal("Internal MongoDB error",e));webPush.notifyUser(s,r[0].email,{title:"Request Approved ",message:"Your request has been approved in property bank by: "+c}),exports.getChangedProperties(i,a,function(e){a(e)})})})})}})})})},exports.declinePropertyChanges=function(i,a){var c=i.auth.credentials.user,s=i.mongo.db,l=i.payload.properties;s.db("vbx_current").collection("vbxReleases").findOne({version:i.payload.version},function(e,n){var t=n.dbName;s=s.db(t);var o=_.map(l,"name"),r=[];s.collection("propertybank").find({name:{$in:o}},function(e,n){n.each(function(e,n){null!=n?r.push(n._id.toString()):s.collection("propertybankDev").find({propertyId:{$in:r}},function(e,n){var t=[];n.each(function(e,n){null!=n?t.push(n.updatedByEmail):s.collection("propertybankDev").updateMany({propertyId:{$in:r},approvalStatus:"pending"},{$set:{approvalStatus:"declined",declinedBy:c}},{w:1,upsert:!0},function(e,n){if(e)return a(Boom.internal("Internal MongoDB error",e));s.collection("propertybank").updateMany({name:{$in:o},isLocked:!0},{$set:{isLocked:!1}},{w:1,upsert:!0},function(e,n){if(e)return a(Boom.internal("Internal MongoDB error",e));console.log("declined"),webPush.notifyUser(s,t[0],{title:"Request declined ",message:"Your request is declined in property bank by "+c}),exports.getChangedProperties(i,a,function(e){a(e)})})})})})})})})};var getComponentsForProperty=function(e,i,a){var c=e.mongo.db,s=[];c.db("vbx_current").collection("vbxReleases").findOne({version:e.payload.version},function(e,n){var t=n.dbName;(c=c.db(t)).collection("componentSchema").find({platform:i.platform},function(e,n){if(e)return reply(Boom.internal("Internal MongoDB error",e));n.each(function(e,n){if(null!=n&&i.platform===n.platform){var t=n.sections,o=n._id.toString(),r=n.componentId;t&&Array.isArray(t)?-1!==getProperties(t).indexOf(i.name)&&s.push({schemaId:o,componentId:r,platform:n.platform}):console.log(o)}else c.collection("components").find().toArray().then(function(e){var r=e;s.forEach(function(n,e,t){var o=_.find(r,function(e){return e._id.toString()===n.componentId});s[e].name=o.name}),a(s)})})})})};exports.updatePropertyDetails=function(e,o){var r=e.payload,i=e.mongo.db;i.db("vbx_current").collection("vbxReleases").findOne({version:e.payload.version},function(e,n){var t=n.dbName;(i=i.db(t)).collection("propertybank").findOne({_id:ObjectId(r._id)},function(e,n){if(e)return o(Boom.internal("Internal MongoDB error",e));var t={};t.category=r.category,t.defaultVal=r.defaultVal,t.description=r.description,""!==r.csDescription&&(n.csDescription?t.csDescription=n.csDescription:t.csDescription={},t.csDescription[r.componentSchemaId]=r.csDescription),t.members=r.members,t.section=r.section,t.title=r.title,""!==r.csTitle&&(n.csTitle?t.csTitle=n.csTitle:t.csTitle={},t.csTitle[r.componentSchemaId]=r.csTitle),t.type=r.type,t.value=r.value,t.configuration=r.configuration,i.collection("propertybank").updateOne({_id:ObjectId(r._id)},{$set:t},{w:1,upsert:!0},function(e,n){if(e)return o(Boom.internal("Internal MongoDB error",e));o(n)})})})},exports.updatePropertyDetailsOnDev=function(b,h){var S=b.payload,D=b.auth.credentials.user,I=b.auth.credentials._id,B=b.payload.changeMsg,e=new Date,x=e.getFullYear()+"-"+(e.getMonth()+1)+"-"+e.getDate()+" "+e.getHours()+":"+e.getMinutes()+":"+e.getSeconds(),P=b.mongo.db,n=[];S.members&&"string"!=typeof S.members&&0<S.members.length&&S.members.forEach(function(e){return n.push(e.caption)}),_promise2.default.all([translate(S.title||" ",{from:"en",to:"de"}),translate(S.description||" ",{from:"en",to:"de"}),translate(S.csTitle||" ",{from:"en",to:"de"}),translate(S.csDescription||" ",{from:"en",to:"de"}),translate(0<n.length?n:" ",{from:"en",to:"de"})]).then(function(e){var f=e[0],m=e[1],g=e[2],v=e[3],y="";0<n.length&&(y=e[4].split(",").map(function(e,n){return _extends({},S.members[n],{caption:{en:S.members[n].caption,de:e}})})),P.db("vbx_current").collection("vbxReleases").findOne({version:b.payload.version},function(e,n){var t=n.dbName;(P=P.db(t)).collection("propertybank").findOneAndUpdate({name:S.name,platform:S.platform},{$set:{isLocked:!0}},{w:1,upsert:!0},function(e,n){if(e)return h(Boom.internal("Internal MongoDB error",e));if(n=n.value){var t=JSON.parse((0,_stringify2.default)(n));delete t._id,f=t.title?t.title.en===S.title?t.title.de:f:S.title,m=t.description?t.description.en===S.description?t.description.de:m:S.description;var o={};if(o.category=S.category,o.defaultVal=[],"PBI"===S.platform){var r=S.section,i=S.componentname,a=t.defaultVal,c=[],s=!0,l="";if("formatting"==S.type)S.structuralType&&(l=(0,_keys2.default)(S.structuralType).filter(function(e){if(1==S.structuralType[e])return e}));if(a)if(a&&"object"==(void 0===a?"undefined":_typeof(a))){if(a.forEach(function(e){if(e.component==i&&e.section==r){var n={};n.component=i,n.section=r,n.value=S.defaultVal,e.formatting&&(n.formatting=l.toString()),c.push(n),s=!1}else c.push(e)}),s){var p={};p.component=i,p.section=r,p.value=S.defaultVal,"formatting"==S.type&&(p.formatting=l.toString()),c.push(p)}o.defaultVal=c}else o.defaultVal=S.defaultVal;else{var u={};u.component=i,u.section=r,u.value=S.defaultVal,u.title=S.title,u.description=S.description,"formatting"==S.type&&(u.formatting=l.toString()),c.push(u),o.defaultVal=c}var d={};"formatting"==S.type&&S.structuralType&&((0,_keys2.default)(S.structuralType).forEach(function(e){S.structuralType[e]&&(d[e]=!0)}),o.structuralType=d),o.structuralType||(o.structuralType=S.structuralType)}o.description={en:S.description,de:m},"PBI"===S.platform&&(o.description=S.description),t.csDescription&&(o.csDescription=_.cloneDeep(t.csDescription)),t.csTitle&&(o.csTitle=_.cloneDeep(t.csTitle)),""!==S.csDescription?(n.csDescription?o.csDescription=_.cloneDeep(n.csDescription):o.csDescription={},t.csDescription&&t.csDescription[S.componentSchemaId]&&(v=S.csDescription===t.csDescription[S.componentSchemaId].en?t.csDescription[S.componentSchemaId].de:v),o.csDescription[S.componentSchemaId]={en:S.csDescription,de:v}):o.csDescription&&o.csDescription.hasOwnProperty(S.componentSchemaId)&&delete o.csDescription[S.componentSchemaId],t.members&&0<t.members.length&&t.members.forEach(function(e,n){e&&e.caption&&y[n]&&y[n].caption&&(y[n].caption.de=e.caption.en===y[n].caption.en?e.caption.de:y[n].caption.de)}),o.members=y||S.members,"PBI"===S.platform&&(o.members=S.members),o.section="",o.title={en:S.title,de:f},"PBI"===S.platform&&(o.title=S.title),""!==S.csTitle?(n.csTitle?o.csTitle=_.cloneDeep(n.csTitle):o.csTitle={},t.csTitle&&t.csTitle[S.componentSchemaId]&&(g=S.csTitle===t.csTitle[S.componentSchemaId].en?t.csTitle[S.componentSchemaId].de:g),o.csTitle[S.componentSchemaId]={en:S.csTitle,de:g}):o.csTitle&&o.csTitle.hasOwnProperty(S.componentSchemaId)&&delete o.csTitle[S.componentSchemaId],o.type=S.type,o.value=S.value,o.configuration=S.configuration,P.collection("propertybankDev").insertOne({propertyId:n._id.toString(),oldPropertyData:t,newPropertyData:o,updatedBy:D,updatedByEmail:I,updatedOn:x,changeMsg:B,approvalStatus:"pending",platform:t.platform},function(e,n){if(e)return h(Boom.internal("Internal MongoDB error",e));console.log("Here"),webPush.notifyAdmins(b.mongo.db,{title:"New Request in PropertyBank by "+D,message:"Commit Message : "+B}),h(n)})}})})}).catch(function(e){console.log(e),h(e.toString())})},exports.addProperty=function(e,o){var r=e.payload,i=r.name,a=e.mongo.db;a.db("vbx_current").collection("vbxReleases").findOne({version:e.payload.version},function(e,n){var t=n.dbName;(a=a.db(t)).collection("propertybank").findOne({name:i,platform:r.platform},function(e,n){if(e)return o(Boom.internal("Internal MongoDB error",e));n?o(n).code(303):a.collection("propertybank").insertOne({name:i,platform:r.platform},function(e,n){console.log("Inserted a document into the propertybank collection."),o(n).code(201)})})})},exports.getChangedComponents=function(e,u,d){var f=e.mongo.db,r="",m="";e.query.contribution||e.payload&&e.payload.contribution?(r="componentProperties",m="componentPropertiesDev"):(r="componentSchema",m="componentSchemaDev"),f.db("vbx_current").collection("vbxReleases").findOne({version:e.query.version?e.query.version:e.payload.version},function(e,n){var t=n.dbName;f=f.db(t);var o,l=[],p=0;o=function(){l.forEach(function(e,n){var r,i,t,a,c,o=e.componentId,s=e.schemaId;i=n,t=o,a=s,c=function(){0===p&&(d?d(l):u(l))},p++,(r=f).collection("components").findOne({_id:ObjectId(t)},function(t,o){r.collection(m).findOne({schemaId:a,approvalStatus:"pending"},function(e,n){p--,t?console.log(t):(l[i].name=o.name,n&&(l[i].lockedBy=n.updatedBy)),c()})})}),0===p&&(d?d(l):u(l))},f.collection(r).find({isLocked:!0}).each(function(e,n){null!=n?l.push({componentId:n.componentId,schemaId:n._id.toString(),platform:n.platform}):o()})})},exports.getChangedProperties=function(e,r,i){var a=e.mongo.db;a.db("vbx_current").collection("vbxReleases").findOne({version:e.query.version?e.query.version:e.payload.version},function(e,n){var t=n.dbName;a=a.db(t);var o=[];a.collection("propertybankDev").find({approvalStatus:"pending"}).each(function(e,n){null!=n?o.push(n):i?i({lockedProperties:o}):r({lockedProperties:o})})})},exports.getSchemaChanges=function(e,o,r){var i=JSON.parse(e.query.component),a=e.mongo.db;a.db("vbx_current").collection("vbxReleases").findOne({version:e.query.version},function(e,n){var t=n.dbName;(a=a.db(t)).collection("componentSchemaDev").findOne({schemaId:i.schemaId,approvalStatus:"pending"},function(e,n){r?r(n):o(n)})})},exports.declineSchemaChanges=function(o,r){var i=o.payload.component,a=o.auth.credentials.user,e=new Date,c=e.getFullYear()+"-"+(e.getMonth()+1)+"-"+e.getDate()+" "+e.getHours()+":"+e.getMinutes()+":"+e.getSeconds(),s=o.mongo.db;s.db("vbx_current").collection("vbxReleases").findOne({version:o.payload.version},function(e,n){var t=n.dbName;(s=s.db(t)).collection("componentSchemaDev").findOne({schemaId:i.schemaId,approvalStatus:"pending"},function(e,n){n.updatedBy.toLowerCase()===a.toLowerCase()||-1!==o.auth.credentials.scope.indexOf("ADMIN")?s.collection("componentSchemaDev").findOneAndUpdate({schemaId:i.schemaId,approvalStatus:"pending"},{$set:{declinedBy:a,approvalStatus:"declined",declinedOn:c}},{w:1,upsert:!0},function(e,t){if(e)return r(Boom.internal("Internal MongoDB error",e));s.collection("componentSchema").findOneAndUpdate({_id:ObjectId(i.schemaId)},{$set:{isLocked:!1}},{w:1,upsert:!0},function(e,n){console.log(n.value),webPush.notifyUser(s,t.value.updatedByEmail,{title:"Your request has been declined by: "+a,message:"Commit Message : "+t.value.changeMsg}),exports.getChangedComponents(o,r,function(e){r({lockedComponents:e,oldTreeData:t.value.oldSchema})})})}):r("Illegal access").code(401)})})},exports.approveSchemaChanges=function(o,l){var r=o.payload.component,i=o.auth.credentials.user,e=new Date,a=e.getFullYear()+"-"+(e.getMonth()+1)+"-"+e.getDate()+" "+e.getHours()+":"+e.getMinutes()+":"+e.getSeconds(),p=o.mongo.db;p.db("vbx_current").collection("vbxReleases").findOne({version:o.payload.version},function(e,n){var t=n.dbName;(p=p.db(t)).collection("componentSchemaDev").findOne({schemaId:r.schemaId,approvalStatus:"pending"},function(e,t){return e?l(Boom.internal("Internal MongoDB error",e)):t.newSchema?void p.collection("componentSchema").updateOne({_id:ObjectId(r.schemaId)},{$set:{sections:t.newSchema,isLocked:!1}},{w:1,upsert:!0},function(e,n){if(e)return l(Boom.internal("Internal MongoDB error",e));p.collection("componentSchemaDev").findOneAndUpdate({schemaId:r.schemaId,approvalStatus:"pending"},{$set:{approvedBy:i,approvalStatus:"approved",approvedOn:a,prStatus:"pending"}},{w:1,upsert:!0},function(e,n){if(webPush.notifyUser(p,n.value.updatedByEmail,{title:"Your request has been approved by: "+i,message:"Commit Message : "+n.value.changeMsg}),e)return l(Boom.internal("Internal MongoDB error",e));exports.getChangedComponents(o,l,function(o){var e,r,i,a,c,s=(e=t.newSchema,r=[],i=[],a=[],c=[],function n(t,e){e.forEach(function(e){"sections"===t&&r.push(e.name),"subsections"===t&&i.push(e.name),"groups"===t&&a.push(e.name),"properties"===t&&c.push(e),e.hasOwnProperty("subsections")?n("subsections",e.subsections):e.hasOwnProperty("group")?n("groups",e.group):e.hasOwnProperty("properties")&&n("properties",e.properties)})}("sections",e),{sections:r,subsections:i,groups:a,properties:c});p.collection("menuData").find(function(e,n){n.toArray().then(function(e){e=e.map(function(e){return e.name}),s=[].concat(s.sections||[]).concat(s.subsections||[]).concat(s.groups||[]),s=_.filter(s,function(e){return""!==e});var t=_.difference(s,e);0<t.length?translate(t,{from:"en",to:"de"}).then(function(e){var n=(e=e.split(",")).map(function(e,n){return{name:t[n],en:t[n],de:e}});p.collection("menuData").insertMany(n,function(e,n){l(o)})}):l(o)})})})})}):l(Boom.internal("No schema found",e))})})},exports.previewChanges=function(o,r){var i=void 0,a=void 0,c=void 0,s=require("./generateHtmlForPreview").generateHtml,l=o.mongo.db;l.db("vbx_current").collection("vbxReleases").findOne({version:o.query.version?o.query.version:o.payload.version},function(e,n){var t=n.dbName;l=l.db(t),"get"===o.method?(i=JSON.parse(o.query.component),c=o.query.type,s(l,i,"html",c,null,"prod",function(e,n){r(n)})):(i=o.payload.component,a=o.payload.schema,s(l,i,"html",c,a,"prod",function(e,n){r(n)}))})},exports.getVersions=function(e,t){var n=e.mongo.db.db("vbx_current").collection("vbxReleases").find(),o=[];n.each(function(e,n){null!=n?o.push(n):t(o)})},exports.createVersionStash=function(t,o){var r=t.mongo.db,e=t.payload.version.replace(".",""),i=t.payload.branchName,a=(new Date).toString("dd/mm/yyyy hh:MM:ss"),c=t.auth.credentials.user,s="vbx_"+e,n={copydb:1,fromhost:process.env.serverHost,fromdb:"vbx_current",todb:s};r.admin().command(n,function(e,n){e?o(e.errmsg):r.db("vbx_current").collection("vbxReleases").insertOne({version:t.payload.version,dbName:s,branchName:i,createdAt:a,createdBy:c},function(e,n){o(e||n)})})},exports.generatePR=function(e,i){var s=e.mongo.db,o=require("./generateHtmlForPreview").generateHtml,a=[],c=[],l=[],p=[],u=function(e,n,t){o(e,n,"file","new",null,"dev",function(e,n){t(null)})},d=function(e,t){var o="**Relevant Changes:**\n",n=d3.queue();e=_.uniqBy(e,function(e){return e.name.concat(e.platform)});var r=_.filter(e,function(e){return"VBX"===e.platform}),i=_.filter(e,function(e){return"PBI"===e.platform}),a=i.reduce(function(e,n,t,o){return e.push(ObjectId(n.componentId)),e},[]),I=function(e){return""+e.charAt(0).toUpperCase()+e.slice(1)},c=function(t){new _promise2.default(function(t,o){s.collection("components").aggregate([{$lookup:{from:"componentSchema",localField:"_id",foreignField:"cId",as:"schemaDetails"}},{$unwind:"$schemaDetails"}],function(e,n){e&&o("Internal MongoDB error"),t(n)})}).then(function(o){var r={};s.collection("propertybank").find({platform:"VBX"},function(e,n){n.toArray().then(function(e){e.forEach(function(t){"dynamic"!==t.type&&(t.csTitle&&0<(0,_keys2.default)(t.csTitle).length&&(0,_keys2.default)(t.csTitle).forEach(function(n){if(_.find(o,function(e){return e.schemaDetails._id.toString()===n})){var e=_.find(o,function(e){return e.schemaDetails._id.toString()===n}).name;r[e]||(r[e]={}),r[e][t.name]=t.title.de||""}}),t.csDescription&&0<(0,_keys2.default)(t.csDescription).length&&(0,_keys2.default)(t.csDescription).forEach(function(n){if(_.find(o,function(e){return e.schemaDetails._id.toString()===n})){var e=_.find(o,function(e){return e.schemaDetails._id.toString()===n}).name;r[e]||(r[e]={}),r[e][t.name+"_desc"]=t.description.de||""}}),r.default||(r.default={}),t.members&&"string"!=typeof t.members&&0<t.members.length&&t.members.forEach(function(e){r.default[e.name+"_member"]=e.caption.de||""}),r.default[t.name]=t.title&&t.title.de?t.title.de:"",r.default[t.name+"_desc"]=t.description&&t.description.de?t.description.de:"")}),s.collection("menuData").find(function(e,n){n.toArray().then(function(e){e.forEach(function(e){r.default||(r.default={}),r.default[e.name]=e.de}),fs.writeFile(config.get("application.localeLocation")+"/de.js","var deLanguagePack = "+(0,_stringify2.default)(r,null,4)+";",function(e){e?console.log("locale file write error"):console.log("locale generated"),t(null)})}).catch(function(e){console.log(e.stack)})})}).catch(function(e){console.log(e.stack)})})}).catch(function(e){console.log(e.stack)})};n.defer(function(o){var r=performance.now();0<a.length?simpleGitPBI.checkout("aps-tool").pull("upstream","master",{"--no-edit":null},function(){s.collection("propertybank").find({platform:"PBI"},function(e,n){n.toArray().then(function(e){var S,n,D;S=e,n=function(e){if(e)o(e);else{var n=performance.now();console.log("PBI generateion time: "+(n-r)/1e3+"s");var t=[];t.push("**Relevant Changes:**"),i.forEach(function(e){t.push("**Capabilities -** "+e.changeMsg+" `"+e._id.toString()+"`")}),simpleGitPBI.add("./*").commit(t,function(e){e?console.log("PBI - failed to commit #"):console.log("PBI Commited successfully"),o(null,{platform:"PBI",body:t.join("\n")})})}},D={bool:"boolean",enumeration:"string",fill:"string","formatting.fontSize":"number","formatting.alignment":"string","formatting.labelDisplayUnits":"number",numeric:"number",integer:"number",text:"string"},s.collection("componentSchema").aggregate([{$match:{cId:{$in:a}}},{$lookup:{from:"components",localField:"cId",foreignField:"_id",as:"componentDetails"}},{$unwind:"$componentDetails"}],function(e,b){var h;a.forEach(function(n){var t={},e=_.cloneDeep(_.find(b,function(e){return e.cId.toString()===n.toString()})),u=e.componentDetails.name,o=e.sections,d=[],r=[];o.forEach(function(e){r.push("public "+e.techName+" = new "+I(e.techName)+"();"),t[e.techName]={displayName:e.name},d.push("export class "+I(e.techName)+" {");var p=e.techName;if(e.properties){var n=e.properties.reduce(function(e,n){var t=_.cloneDeep(_.find(S,{name:n})),o=(t=_.pick(t,["name","title","type","members","structuralType","defaultVal"])).type;t.type={},t.type[o]=!0,"fill"==o&&(t.type[o]={solid:{color:!0}});var r=D[o];if(_.isEmpty("")||(r=D[o+"."],t.type={},t.type[o]={},t.type[o][""]=!0),t.displayName=t.title,"enumeration"===o){var i=t.members.map(function(e){return{displayName:e.caption.en?e.caption.en:e.caption,value:e.name}});t.type={},t.type[o]=i}if("formatting"===o){var a=void 0;(0,_keys2.default)(t.structuralType).forEach(function(e){if(t.structuralType[e])return a=e,!1}),a&&(r=D[t.type+"."+a]),"fontSize"==a||"labelDisplayUnits"==a?r="number":"alignment"==a&&(r="string"),t.type[o]={},t.type[o][a]=!0}var c="",s=t.defaultVal;if(s)if("object"!=(void 0===s?"undefined":_typeof(s)))c=s.toString();else{var l=s.find(function(e){return e.section==p&&e.component==u});_.isEmpty(l)?c="":(c=l.value,t.description=l.description)}return"string"===r&&(c="'"+c+"'"),d.push("public "+n+": "+r+" = "+c+";"),t=_.omit(t,["name","title","description","members","structuralType","defaultVal"]),e[n]=t,e},{});t[e.techName].properties=n}d.push("}")});var i=_.find(b,function(e){return e.cId.toString()===n.toString()}).componentDetails.name,a=config.get("application.pbiSourceLocation")+"/"+i+"/",c=void 0;fs.readdirSync(a).forEach(function(e){var n=""+a+e;if(fs.statSync(n).isDirectory())fs.readdirSync(n).forEach(function(e){return fs.existsSync(n+"/pbiviz.json")?(c=n,!1):!c&&void 0});else if("pbiviz.json"===e)return c=a,!1;if(c)return!1});var s=r.join("\r\n"),l=d.join("\r\n"),p=fs.readFileSync(c+"/capabilities.json","utf8"),f=JSON.parse(p);f.objects=t,fs.writeFileSync(c+"/capabilities.json",stringify(f,{space:4}));var m=fs.readFileSync(path.join(__dirname,"./settings.template.ts")),g=Handlebars.compile(m.toString(),{noEscape:!0}),v=c+"/src/settings.ts";try{var y=prettier.format(g({visualSettings:s,groupClasses:l}),{parser:"typescript"});fs.writeFileSync(v,y)}catch(e){return h=e.toString(),!1}}),n(h?"ts formatting error".concat("\n",h):null)})}).catch(function(e){console.log(e.stack)})})}):o(null)}),n.defer(function(n){if(0<r.length){var e=d3.queue();simpleGit.checkout("aps-tool").pull("upstream","master",{"--no-edit":null},function(){r.forEach(function(e){o+="**Schema -** "+e.changeMsg+" `"+e._id.toString()+"`\n"}),e.defer(u,s,r),e.defer(c),e.awaitAll(function(e){if(e)throw e;n(null,{platform:"VBX",body:o})})})}else n(null)}),n.awaitAll(function(e,n){t(e||null,n)})},f=function(o,r){getComponentsForProperty(e,o,function(e){var n=_.map(e,function(e){return _.assignIn(e,{changeMsg:o.changeMsg},{updatedBy:o.updatedBy},{_id:o._id})}),t=[].concat(n);r(null,t)})};s.db("vbx_current").collection("vbxReleases").findOne({version:e.payload.version},function(e,n){var t=n.dbName;s=s.db(t);var r=[];s.collection("propertybankDev").aggregate([{$match:{prStatus:"pending"}},{$project:{"oldPropertyData.name":!0,changeMsg:!0,updatedBy:!0,platform:!0}}],function(e,n){if(e)return i(e.toString());n.forEach(function(e){r.push({name:e.oldPropertyData.name,changeMsg:e.changeMsg,updatedBy:e.updatedBy,_id:e._id.toString(),platform:e.platform}),"VBX"===e.platform?l.push(e._id):p.push(e._id)});var o=d3.queue();(r=_.uniqBy(r,function(e){return e.name.concat(e.platform)})).forEach(function(e,n,t){o.defer(f,e)}),o.awaitAll(function(e,n){if(e)throw e;var t,o;t=function(e){d3.queue().defer(d,[].concat.apply([],n).concat(e)).await(function(e,n){var o,t,r;e?i(e):(console.log("Files Generated. PR generation initiated"),o=n,t=function(e,n){e?(console.log(e.stack||e),i("Failed to create PR")):i(n.join("-"))},(r=d3.queue()).defer(function(t){console.log("VBX PR Start"),_.find(o,{platform:"VBX"})?simpleGit.checkout("aps-tool").pull("upstream","master").push("origin","aps-tool",function(){console.log("Pushed to origin"),axios.post("https://api.github.com/repos/visualbis/VBI_DX_Suite/pulls",{title:"**APS-TOOL** Update",body:_.find(o,{platform:"VBX"}).body,head:"vbxdesignstudio:aps-tool",base:"master"},{headers:{Authorization:"token "+process.env.gitToken}}).then(function(e){console.log("VBX - PR created successfully"),s.collection("componentSchemaDev").updateMany({_id:{$in:a},platform:"VBX"},{$set:{prStatus:"created"}},{w:1},function(e,n){if(e)return i(Boom.internal("Internal MongoDB error",e));s.collection("propertybankDev").updateMany({_id:{$in:l},platform:"VBX"},{$set:{prStatus:"created"}},{w:1},function(e,n){if(e)return i(Boom.internal("Internal MongoDB error",e));t(null,"VBX - PR created successfully")})})}).catch(function(e){try{-1!==e.response.data.errors[0].message.indexOf("A pull request already exists")?s.collection("componentSchemaDev").updateMany({_id:{$in:a}},{$set:{prStatus:"created"}},{w:1},function(e,n){if(e)return i(Boom.internal("Internal MongoDB error",e));s.collection("propertybankDev").updateMany({_id:{$in:l}},{$set:{prStatus:"created"}},{w:1},function(e,n){if(e)return i(Boom.internal("Internal MongoDB error",e));t(null,"VBX - Included with previous PR")})}):(console.log(e.stack||e),t(null,"VBX - Failed to create PR"))}catch(e){console.log(e.stack||e),t(null,"VBX - Failed to create PR")}})}):t(null,"VBX - N/A")}),r.defer(function(t){console.log("PBI PR Start"),_.find(o,{platform:"PBI"})?simpleGitPBI.checkout("aps-tool").pull("upstream","master").push("origin","aps-tool",function(){console.log("PBI Pushed to origin"),axios.post("https://api.github.com/repos/visualbis/PowerBI/pulls",{title:"**APS-TOOL** Update",body:_.find(o,{platform:"PBI"}).body,head:"vbxdesignstudio:aps-tool",base:"master"},{headers:{Authorization:"token "+process.env.gitToken}}).then(function(e){console.log("PBI - PR created successfully"),s.collection("componentSchemaDev").updateMany({_id:{$in:c},platform:"PBI"},{$set:{prStatus:"created"}},{w:1},function(e,n){if(e)return i(Boom.internal("Internal MongoDB error",e));s.collection("propertybankDev").updateMany({_id:{$in:p},platform:"PBI"},{$set:{prStatus:"created"}},{w:1},function(e,n){if(e)return i(Boom.internal("Internal MongoDB error",e));t(null,"PBI - PR created successfully")})})}).catch(function(e){try{-1!==e.response.data.errors[0].message.indexOf("A pull request already exists")?s.collection("componentSchemaDev").updateMany({_id:{$in:c}},{$set:{prStatus:"created"}},{w:1},function(e,n){if(e)return i(Boom.internal("Internal MongoDB error",e));s.collection("propertybankDev").updateMany({_id:{$in:p}},{$set:{prStatus:"created"}},{w:1},function(e,n){if(e)return i(Boom.internal("Internal MongoDB error",e));t(null,"PBI - Included with previous PR")})}):(console.log(e.stack||e),t(null,"PBI - Failed to create PR"))}catch(e){console.log(e.stack||e),t(null,"PBI - Failed to create PR")}})}):t(null,"PBI - N/A")}),r.awaitAll(function(e,n){t(e,n)}))})},o=[],s.collection("componentSchemaDev").aggregate([{$match:{sId:{$exists:!0},prStatus:"pending"}},{$lookup:{from:"componentSchema",localField:"sId",foreignField:"_id",as:"schemaDetails"}},{$unwind:"$schemaDetails"},{$lookup:{from:"components",localField:"cId",foreignField:"_id",as:"componentDetails"}},{$unwind:"$componentDetails"}],function(e,n){if(e)return i(e.toString());n.forEach(function(e){o.push({schemaId:e.schemaDetails._id.toString(),name:e.componentDetails.name,updatedBy:e.updatedBy,changeMsg:e.changeMsg,_id:e._id.toString(),platform:e.platform,componentId:e.cId.toString()}),"VBX"===e.platform?a.push(e._id):c.push(e._id)}),t(o)})})})})};var getProperties=function r(e,n){var i=[];return e.forEach(function(e,n,t){if(e.hasOwnProperty("properties"))e.properties.forEach(function(e,n,t){i.push(e)});else for(var o in e){if(Array.isArray(e[o]))r(e[o]).forEach(function(e,n,t){i.push(e)})}}),i},getPropertiesForPBI=function(y,e,c,n){var b=[],s=[],h=[];return e.hasOwnProperty("objects")&&(s=e.objects),(0,_keys2.default)(s).forEach(function(g,e,n){if(s[g].hasOwnProperty("properties")){h=s[g].properties;var t="public \\b"+g.toString()+"\\b(.*?)= new (.*?)\\(\\);",o=new RegExp(t,"gm").exec(c)[2],r="export class "+o.toString()+" {(.|\\r\\n|\\n)*?}\\\\r\\\\n",i=new RegExp(r),a="";null!=i.exec(c)?a=i.exec(c).toString():(r="export class "+o.toString()+" {(.|\\r\\n|\\n)*?}(\\r\\n|\\n)",a=(i=new RegExp(r)).exec(c).toString());var v=a.replace("/","").replace("\\","");(0,_keys2.default)(h).forEach(function(n,e,t){var r={members:[]},o=h[n].type,i=void 0,a=void 0,c=h[n].description?h[n].description:"",s=h[n].displayName;"object"==(void 0===o?"undefined":_typeof(o))?(i=(0,_keys2.default)(o)[0],a=o[i]):i=o;var l=new RegExp("public "+n+":(.*?)=(.*?);").exec(v),p=l[2];"string"===l[1].trim().toLowerCase()&&(p=(p=(p=(p=p.trim()).replace(/\\\"/g,'"')).replace(/\\\'/g,"'")).substr(1,p.length-2)),p=p.trim(),"number"===l[1].trim().toLowerCase()&&(p=parseInt(p)),"true"==p?p=!0:"false"==p&&(p=!1);var u=b.find(function(e){return e.name===n});if(u){var d="";if(h[n].type.formatting){var f=h[n].type.formatting;d=(0,_keys2.default)(f).filter(function(e){if(1==f[e])return e}).toString(),u.defaultVal.push({component:y,section:g,value:p,title:s,description:c,formatting:d})}else u.defaultVal.push({component:y,section:g,value:p,title:s,description:c})}else{"enumeration"==i?(0,_keys2.default)(a).forEach(function(e,n){var t=a[e],o={caption:t.displayName.toString(),name:t.value};r.members.push(o)}):"fill"!=i&&"formatting"!=i||(r.structuralType=a),r.name=n.toString(),r.platform="PBI",r.isLocked=!1,r.category="",r.configuration={},r.csDescription={},r.defaultVal=[];var m="";r.structuralType&&"formatting"==i?(m=(0,_keys2.default)(r.structuralType).filter(function(e){if(1==r.structuralType[e])return e}),r.defaultVal.push({component:y,section:g,value:p,title:s,description:c,formatting:m.toString()})):r.defaultVal.push({component:y,section:g,value:p,title:s,description:c}),r.description="",r.members||(r.members=[]),r.section="",r.structuralType||(r.structuralType={}),r.type=i.toString(),r.value="",r.title=h[n].displayName,b.push(r)}})}}),b},getComponentSchemaForPBI=function(e){var r=[],i=e.objects;return(0,_keys2.default)(i).forEach(function(e){var n={};n.name=i[e].displayName,n.techName=e;var t=i[e].properties,o=[];(0,_keys2.default)(t).forEach(function(e){o.push(e.toString())}),n.properties=o,r.push(n)}),r};exports.analyzeSchema=function(e,a,c){var s=e.mongo.db,n=e.payload.schema,l=e.payload.platform,t=e.payload.componentName,p=[],u=[],i=[];if("VBX"==l)p=getProperties(n),s.db("vbx_current").collection("vbxReleases").findOne({version:e.payload.version},function(e,n){var t=n.dbName,r=p.length,i=p.length;s=s.db(t);0<p.length?p.forEach(function(e,n,t){var o;o=e,s.collection("propertybank").findOne({name:o,platform:l},function(e,n){i--,n||u.push(o),0===i&&(c?c({newProperties:u,totalProperties:r}):a({newProperties:u,totalProperties:r}))})}):c?c({newProperties:[],totalProperties:0}):a({newProperties:[],totalProperties:0})});else{var o=e.payload.settingsTsFile;p=getPropertiesForPBI(t,n,o),s.db("vbx_current").collection("vbxReleases").findOne({version:e.payload.version},function(e,n){var t=n.dbName,o=p.length;(s=s.db(t)).collection("propertybank").find({platform:l},function(e,n){if(e)return a(Boom.internal("Internal MongoDB error",e));n.toArray().then(function(r){0<p.length?(p.forEach(function(n,e,t){var o=r.find(function(e){return e.name===n.name});o?(n.defaultVal=[].concat(_toConsumableArray(o.defaultVal),_toConsumableArray(n.defaultVal)),i.push(n)):u.push(n)}),c?c({newProperties:u,totalProperties:o,propertiesTobeUpdated:i}):a({newProperties:u,totalProperties:o,propertiesTobeUpdated:i})):c?c({newProperties:[],totalProperties:0}):a({newProperties:[],totalProperties:0})})})})}},exports.createComponent=function(n,c){var s=n.mongo.db,l=n.payload.schema,p=n.payload.componentName,u=n.payload.platform;exports.analyzeSchema(n,c,function(e){var o=e.newProperties,r=[];if("PBI"==u){var i=getComponentSchemaForPBI(l),a=e.propertiesTobeUpdated;o.forEach(function(e,n,t){r.push({name:e.name,platform:e.platform,isLocked:e.isLocked,category:e.category,configuration:e.configuration,csDescription:e.csDescription,defaultVal:e.defaultVal,description:e.description,members:e.members,section:e.section,structuralType:e.structuralType,title:e.title,type:e.type,value:e.value})}),s.db("vbx_current").collection("vbxReleases").findOne({version:n.payload.version},function(e,n){var t=n.dbName;(s=s.db(t)).collection("components").findOne({name:p,platform:u},function(e,n){n?c(n).code(303):s.collection("propertybank").insertMany(r,function(e,o){s.collection("components").insertOne({name:p,platform:u},function(e,n){s.collection("componentSchema").insertOne({sections:i,componentId:n.insertedId.toString(),cId:n.insertedId,platform:u,isLocked:!1},function(e,n){try{if(_.isEmpty(a))c(o).code(201);else{var t=a.length;a.forEach(function(e){s.collection("propertybank").updateOne({name:e.name,platform:"PBI"},{$set:{defaultVal:e.defaultVal}},{w:1,upsert:!0},function(e,n){if(e)return c(Boom.internal("Internal MongoDB error",e));0===--t&&c(o).code(201)})})}}catch(e){c(e.toString())}})})})})})}else s.db("vbx_current").collection("vbxReleases").findOne({version:n.payload.version},function(e,n){var t=n.dbName;s=s.db(t),o.forEach(function(e,n,t){r.push({name:e,platform:u})}),s.collection("components").findOne({name:p,platform:u},function(e,n){n?c(n).code(303):s.collection("propertybank").insertMany(r,function(e,t){s.collection("components").insertOne({name:p,platform:u},function(e,n){s.collection("componentSchema").insertOne({sections:l,componentId:n.insertedId.toString(),cId:n.insertedId,platform:u},function(e,n){c(t).code(201)})})})})})})},exports.getPendingApproval=function(e,o){var r=e.mongo.db;r.db("vbx_current").collection("vbxReleases").findOne({version:e.query.version},function(e,n){var t=n.dbName;(r=r.db(t)).collection("componentSchemaDev").find({approvalStatus:"pending"},function(e,n){if(e)return o(Boom.internal("Internal MongoDB error",e));n.toArray().then(function(e){var t=e;r.collection("propertybankDev").find({approvalStatus:"pending"},function(e,n){if(e)return o(Boom.internal("Internal MongoDB error",e));n.toArray().then(function(e){o({schemaChanges:t,propChange:e})})})})})})},exports.getPendingPR=function(e,o){var r=e.mongo.db;r.db("vbx_current").collection("vbxReleases").findOne({version:e.query.version},function(e,n){var t=n.dbName;(r=r.db(t)).collection("componentSchemaDev").find({prStatus:"pending"},function(e,n){if(e)return o(Boom.internal("Internal MongoDB error",e));n.toArray().then(function(e){var t=e;r.collection("propertybankDev").find({prStatus:"pending"},function(e,n){if(e)return o(Boom.internal("Internal MongoDB error",e));n.toArray().then(function(e){o({schemaChanges:t,propChange:e})})})})})})},exports.generateAll=function(e,a){var c=e.mongo.db,s=require("./generateHtmlForPreview").generateHtml;c.db("vbx_current").collection("vbxReleases").findOne({version:e.payload.version},function(e,n){var t=n.dbName;c=c.db(t);c.collection("components").find(function(e,n){n.toArray().then(function(e){var r=e,i=r.length;r.forEach(function(t,o){c.collection("componentSchema").findOne({componentId:t._id.toString()},function(e,n){e?console.log(t._id.toString()):r[o].schemaId=n._id.toString(),0===--i&&function(e){e.length;simpleGit.checkout("aps-tool").pull("upstream","master",{"--no-edit":null},function(){s(c,e,"file","new",null,"prod",function(e,n){simpleGit.add("./*").commit("**APS-TOOL** - Generate All",function(e){e?console.log("failed to commit for Generate All"):console.log("Commited successfully"),a("Generated all HTML files")})})})}(r)})})})})})},exports.getCSData=function(e,o){var r=e.mongo.db;r.db("vbx_current").collection("vbxReleases").findOne({version:e.query.version},function(e,n){var t=n.dbName;(r=r.db(t)).collection("components").aggregate([{$lookup:{from:"componentSchema",localField:"_id",foreignField:"cId",as:"schemaDetails"}},{$unwind:"$schemaDetails"}],function(e,i){if(e)return o(e.toString());r.collection("propertybank").find(function(e,n){var r=[];n.toArray().then(function(e){d3.queue();e.forEach(function(t){var o=null;t.csTitle&&(o=t.csTitle,(0,_keys2.default)(o).forEach(function(n){var e={name:t.name,baseTitle:t.title,componentName:_.find(i,function(e){return e.schemaDetails._id.toString()===n}).name,csTitle:o[n]};t.csDescription&&t.csDescription.hasOwnProperty(n)&&(e.csDescription=t.csDescription[n],e.baseDescription=t.description),r.push(e)}))}),o((0,_stringify2.default)(r))})})})})},exports.repairCS=function(e,a){var c=e.mongo.db;c.db("vbx_current").collection("vbxReleases").findOne({version:e.payload.version},function(e,n){var t=n.dbName;(c=c.db(t)).collection("components").aggregate([{$lookup:{from:"componentSchema",localField:"_id",foreignField:"cId",as:"schemaDetails"}},{$unwind:"$schemaDetails"}],function(e,n){if(e)return a(e.toString());c.collection("propertybank").find(function(e,n){n.toArray().then(function(i){var e=d3.queue(),r=function(e,n,t,o){var r={};n&&(r.csTitle=n),t&&(r.csDescription=t),_.isEmpty(r)?o(null,i):c.collection("propertybank").updateOne({_id:e},{$set:r},{w:1},function(e,n){if(e)return console.log(e),a(Boom.internal("Internal MongoDB error",e));o(null,n)})};i.forEach(function(n){var t=null,o=null;n.csTitle&&(o=n.csTitle,(0,_keys2.default)(o).forEach(function(e){n.title!==o[e]&&o[e]||delete o[e]})),n.csDescription&&(t=n.csDescription,(0,_keys2.default)(t).forEach(function(e){n.description!==t[e]&&t[e]||delete t[e]})),(o||t)&&e.defer(r,n._id,o,t)}),e.awaitAll(function(e,n){if(e)throw e;a("Updated successfully")})})})})})},exports.repairCompSchema=function(e,n){var o=e.mongo.db;o.db("vbx_current").collection("vbxReleases").findOne({version:e.payload.version},function(e,n){var t=n.dbName;(o=o.db(t)).collection("componentSchema").find().forEach(function(e){o.collection("componentSchema").update({_id:e._id},{$set:{cId:ObjectId(e.componentId)}})})})};