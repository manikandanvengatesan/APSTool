"use strict";var _assign=require("babel-runtime/core-js/object/assign"),_assign2=_interopRequireDefault(_assign),_extends=_assign2.default||function(e){for(var t=1;t<arguments.length;t++){var n=arguments[t];for(var r in n)Object.prototype.hasOwnProperty.call(n,r)&&(e[r]=n[r])}return e};function _interopRequireDefault(e){return e&&e.__esModule?e:{default:e}}var Boom=require("boom"),fs=require("fs"),Handlebars=require("handlebars"),assert=require("assert"),ObjectId=require("mongodb").ObjectId,_=require("lodash"),map_sources=require("./mapCollections.js").map_sources,config=require("config"),simpleGit=require("simple-git")(config.get("application.dsxSourceLocation")),stringify=require("json-stable-stringify"),d3=require("d3-queue"),properties=void 0;function isHighChartBasedComponent(e){return _.includes(["AdvancedGauge","AdvancedKPITile","AngularGauge","AreaChart","BoxPlotChart","BubbleChart","BulletChart","ChartContainer","ColumnBarChart","ColumnBarChartNew","ColumnBarDrillDownChart","CombinationChart","DonutChart","DualAxesChart","FixedColumnChart","FunnelPyramidChart","FunnelPyramidDrillDownChart","GroupStackedColumnBarChart","HCMap","HeatMapChart","KPITile","LinearGauge","LineChart","MarimekkoChart","MultipleAxesChart","PieChart","PieDrillDownChart","PolarChart","ProgressBar","RadarChart","ScatterChart","SemicircledonutChart","SolidGauge ","SparkLineChart","SparkLineTableChart","StackedAreaChart","StackedColumnBarChart","SuperCombinationChart","TreeMap","TreeMapDrilldown","WaterfallChart","SPieChart","Sankey","ParallelCoordinates","SunBurst","SlopeChart","StreamGraph"],e)}function changeType(e,t){if("MultipleAxesChart"===t&&_.includes(["yaxistitletext","yaxistickinterval","yaxisminortickinterval","yaxislabelprefix","yaxislabelsuffix","tooltipvalueprefix","tooltipvaluesuffix"],e.name)&&(e.type="dynamic"),"HCMap"===t&&"mapsource"===e.name){var n=[];_.forOwn(map_sources,function(e,t){n.push({name:t.toLowerCase(),caption:e.name,group:e.type})}),e.groups={world:"World",continent:"Continents & Regions",custom:"Custom",country:"Countries","ca-admin2":"Canada (Admin 2)","fr-admin2":"France (Admin 2)","de-admin2":"Germany (Admin 2)","de-admin3":"Germany (Admin 3)","nl-admin2":"Netherlands (Admin 2)","no-admin2":"Norway (Admin 2)","us-admin2":"United States (Admin 2)","us-admin3":"United States Congressional Districts (Admin 3)"},e.members=n}}function mapProperties(e,i,o,a,t,s){return _.map(e,function(r){return r.properties&&(r.properties=_.map(r.properties,function(e){var t=_.cloneDeep(_.find(i,{name:e}));t?(t.hasOwnProperty("_id")&&delete t._id,t.title=t.title&&t.title.en?t.title.en:"",t.hasOwnProperty("csTitle")&&t.csTitle.hasOwnProperty(s)&&t.csTitle[s]?(t.title=t.csTitle[s].en||"",delete t.csTitle):t.hasOwnProperty("csTitle")&&delete t.csTitle,t.description=t.description&&t.description.en?t.description.en:"",t.hasOwnProperty("csDescription")&&t.csDescription.hasOwnProperty(s)&&t.csDescription[s]?(t.description=t.csDescription[s].en||"",delete t.csDescription):t.hasOwnProperty("csDescription")&&delete t.csDescription,t.hasOwnProperty("isLocked")&&delete t.isLocked,t.members&&"string"!=typeof t.members&&0<t.members.length&&(t.members=t.members.map(function(e){return _extends({},e,{caption:e.caption.en||""})})),t.category&&delete t.category,t.section&&delete t.section,t.platform&&delete t.platform,t.structuralType&&delete t.structuralType):(console.log("Error : property '"+e+"' not found in property-bank.json"),t={});var n=o.slice(0);return n.push(r.name),t.path=n,changeType(t,a),t}),"dev"!==t&&(r.properties=_.map(r.properties,function(e){return _.omit(e,["category","section"])}))),r})}function generateApsHTML(c,t,l,p,u,d,m){var e=void 0;e="file"===l?"dev"===d?config.get("application.mockTemplate"):config.get("application.prodTemplate"):__dirname+"/component-template-prod.html",fs.readFile(e,function(n,e){if(n)m(n);else{var o=Handlebars.compile(e.toString());if(t){var r=t.schemaId,a=t.name,s=a.toLowerCase()+"_additional_properties_sheet.html";s="dev"===d?config.get("application.mockOutput")+s:config.get("application.prodOutput")+s;var i=function(e,t){var n={},r={};e?r.sections=e.sections:"new"===p&&t.newSchema?r.sections=t.newSchema:r.sections="new"===p?t.sections:t.oldSchema,e?r._id=e._id:t.schemaId?r._id=t.schemaId:r._id=t._id.toString();var i=mapProperties(r.sections,properties,[],a,d,r._id);r.sections=i,_.each(r.sections,function(n){if(n.subsections){var e=n.subsections,t=mapProperties(e,properties,[n.name],a,d,r._id.toString());n.subsections=t,_.each(e,function(e){var t=mapProperties(e.group,properties,[n.name,e.name],a,d,r._id.toString());e.group=t})}}),isHighChartBasedComponent(a)&&r.sections.push({name:"CSS"}),r.sections.push({name:"Tools"}),r.sections.push({name:"Info"}),n.sections=r.sections,l&&"html"===l?m(null,o({componentName:a,properties:stringify(n),domain:process.env.serverHost})):l&&"file"===l?fs.writeFile(s,o({componentName:a,properties:stringify(n)}),function(e){if(e)return console.log(e);m(null,t)}):m("error: invalid responseType")};u?i(u,null):c.collection("componentSchemaDev").findOne({schemaId:r,approvalStatus:"pending"},function(e,t){n&&m(n),t?i(null,t):c.collection("componentSchema").findOne({_id:ObjectId(r)},function(e,t){n&&m(n),i(null,t)})})}else m("invalid component object")}})}exports.generateHtml=function(r,i,o,a,s,c,l){r.collection("propertybank").find({platform:"VBX"},function(e,t){e&&l(e),t.toArray().then(function(e){if(properties=e,"file"===o){var n=[],t=d3.queue(1);i.forEach(function(e){n.push("**APS-TOOL** - "+e.updatedBy+" - "+e.changeMsg+"  #"+e._id.toString()),t.defer(generateApsHTML,r,e,o,a,s,"prod")}),t.awaitAll(function(e,t){if(e)throw e;simpleGit.add("./*").commit(n,function(e){e?console.log("failed to commit #"):console.log("Commited successfully"),l(null)})})}else generateApsHTML(r,i,o,a,s,c,l)})})};