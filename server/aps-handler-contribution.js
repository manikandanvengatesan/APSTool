"use strict";var Boom=require("boom"),config=require("config"),simpleGit=require("simple-git")(config.get("application.dsxSourceLocation")).addConfig("user.name",config.get("application.gitUser")).addConfig("user.email",config.get("application.gitEmail")),axios=require("axios"),_=require("lodash");exports.getcomponentProperties=function(e,t){var r=e.mongo.db,i=e.params.componentId;r.db("vbx_current").collection("vbxReleases").findOne({version:e.query.version},function(e,n){var o=n.dbName;(r=r.db(o)).collection("componentProperties").findOne({componentId:i},function(e,n){if(e)return t(Boom.internal("Internal MongoDB error",e));t(n)})})},exports.updateContributionProperties=function(e,t){var r=e.payload.componentId,i=e.payload.properties,a=e.payload.changeMsg,s=e.auth.credentials.user,n=new Date,c=n.getFullYear()+"-"+(n.getMonth()+1)+"-"+n.getDate()+" "+n.getHours()+":"+n.getMinutes()+":"+n.getSeconds(),p=e.mongo.db;p.db("vbx_current").collection("vbxReleases").findOne({version:e.payload.version},function(e,n){var o=n.dbName;(p=p.db(o)).collection("componentProperties").findOne({componentId:r},function(e,n){n.hasOwnProperty("isLocked")&&n.isLocked?t(n).code(423):p.collection("componentPropertiesDev").insertOne({newSchema:i,oldSchema:n.properties,schemaId:r,changeMsg:a,updatedBy:s,updatedOn:c,approvalStatus:"pending",prStatus:"pending"},function(e,n){if(e)return t(Boom.internal("Internal MongoDB error",e));p.collection("componentProperties").updateOne({componentId:r},{$set:{isLocked:!0}},{w:1},function(e,n){if(e)return t(Boom.internal("Internal MongoDB error",e));t(n)})})})})},exports.getComponentText=function(e,a){var t=e.mongo.db,s=e.query.schemaId;t.db("vbx_current").collection("vbxReleases").findOne({version:e.query.version},function(e,n){var o=n.dbName;(t=t.db(o)).collection("componentPropertiesDev").findOne({schemaId:s},function(e,n){if(e)return a(Boom.internal("Internal MongoDB error",e));var r=!1,i={};!function e(n){var o=(0,require("child_process").spawn)("python",["E:/VBXSUITE/VBI_DX_Suite/aps-cli/aps-web/aps-server-rest/script_generator/jsontotext.py",s,n,!0]),t="";o.stdout.on("data",function(e){t+=e.toString()}),o.stderr.on("end",function(e){if(e&&!1===r)return a({error:r=!0})}),o.stdout.on("end",function(){if("old"==n)i.old=t,e("new");else if(i.new=t,!1===r)return r=!0,a(i)})}("old")})})},exports.approveSchemaChangesCB=function(e,t){var n=e.payload.component,r=e.auth.credentials.user,o=new Date,i=o.getFullYear()+"-"+(o.getMonth()+1)+"-"+o.getDate()+" "+o.getHours()+":"+o.getMinutes()+":"+o.getSeconds(),a=e.mongo.db,s=n.componentId;a.db("vbx_current").collection("vbxReleases").findOne({version:e.payload.version},function(e,n){var o=n.dbName;(a=a.db(o)).collection("componentPropertiesDev").findOne({schemaId:s,approvalStatus:"pending"},function(e,n){if(e)return t(Boom.internal("Internal MongoDB error",e));a.collection("componentProperties").updateOne({componentId:s},{$set:{properties:n.newSchema,isLocked:!1}},{w:1,upsert:!0},function(e,n){a.collection("componentPropertiesDev").updateOne({schemaId:s,approvalStatus:"pending"},{$set:{approvedBy:r,approvalStatus:"approved",approvedOn:i}},{w:1,upsert:!0},function(e,n){t({message:"success"})})})})})},exports.declineSchemaChangesCB=function(e,t){var r=e.payload.component,i=e.auth.credentials.user,n=new Date,a=n.getFullYear()+"-"+(n.getMonth()+1)+"-"+n.getDate()+" "+n.getHours()+":"+n.getMinutes()+":"+n.getSeconds(),s=e.mongo.db;s.db("vbx_current").collection("vbxReleases").findOne({version:e.payload.version},function(e,n){var o=n.dbName;(s=s.db(o)).collection("componentPropertiesDev").updateOne({schemaId:r.componentId,approvalStatus:"pending"},{$set:{declinedBy:i,approvalStatus:"declined",declinedOn:a}},{w:1,upsert:!0},function(e,n){if(e)return t(Boom.internal("Internal MongoDB error",e));s.collection("componentProperties").updateOne({componentId:r.componentId},{$set:{isLocked:!1}},{w:1,upsert:!0},function(e,n){t({message:"success"})})})})},exports.generateTextFiles=function(e,t){var r=e.mongo.db;simpleGit.checkout("xml-tool",function(){r.db("vbx_current").collection("vbxReleases").findOne({version:e.payload.version},function(e,n){var o=n.dbName;(r=r.db(o)).collection("componentPropertiesDev").find({approvalStatus:"approved",prStatus:"pending"},function(e,n){if(e)return t(Boom.internal("Internal MongoDB error",e));n.toArray().then(function(e){var o=e.length;if(0===o)return t({message:"No changes Found",changes:!1});e.forEach(function(e,n){(0,require("child_process").spawn)("python",["E:/VBXSUITE/VBI_DX_Suite/aps-cli/aps-web/aps-server-rest/script_generator/jsontotext.py",e.schemaId,"new",!1]).on("exit",function(e,n){0===--o&&t({message:"success",changes:!0})})})})})})})};var updatePullRequest=function(e,o){e.collection("componentPropertiesDev").update({approvalStatus:"approved",prStatus:"pending"},{$set:{prStatus:"approved"}},{multi:!0,upsert:!0},function(e,n){if(e)return o(Boom.internal("Internal MongoDB error",e));o({message:"Pull Request Created Successfully"})})};exports.generatePullRequestCB=function(e,t){var r=e.mongo.db;r.db("vbx_current").collection("vbxReleases").findOne({version:e.payload.version},function(e,n){var o=n.dbName;(r=r.db(o)).collection("componentPropertiesDev").find({approvalStatus:"approved",prStatus:"pending"},function(e,n){n.toArray().then(function(e){var n=_.map(e,"updatedBy"),o=_.map(e,"changeMsg");simpleGit.add("./*").commit("**XML-TOOL** - "+n.join(", ")+" - "+o.join(", "),function(e){e?console.log("failed to commit for #"):(console.log("Commited successfully"),simpleGit.pull("upstream","master",{"--no-edit":null},function(){simpleGit.add("./*").commit("Merge branch 'master' of https://github.com/visualbis/VBI_DX_Suite into xmltool").push("origin","xml-tool",function(){axios.post("https://api.github.com/repos/visualbis/VBI_DX_Suite/pulls",{title:"**XML-TOOL** Update",body:"**XML-TOOL**",head:"vbimanonmanim:xml-tool",base:"master"},{headers:{Authorization:"token "+config.get("application.gitToken")}}).then(function(e){if(201!==e.status)return t({message:"Pull request Not created"});updatePullRequest(r,t)}).catch(function(e){return t({message:"Pull request Not created"})})})}))})})})})};