"use strict";var Boom=require("boom"),config=require("config"),simpleGit=require("simple-git")(config.get("application.dsxSourceLocation")).addConfig("user.name",config.get("application.gitUser")).addConfig("user.email",config.get("application.gitEmail")),axios=require("axios"),_=require("lodash");exports.getcomponentProperties=function(e,n){var o=e.mongo.db,t=e.params.componentId;o.db("vbx_current").collection("vbxReleases").findOne({version:e.query.version},function(e,r){var i=r.dbName;(o=o.db(i)).collection("componentProperties").findOne({componentId:t},function(e,o){if(e)return n(Boom.internal("Internal MongoDB error",e));n(o)})})},exports.updateContributionProperties=function(e,n){var o=e.payload.componentId,t=e.payload.properties,r=e.payload.changeMsg,i=e.auth.credentials.user,a=new Date,s=a.getFullYear()+"-"+(a.getMonth()+1)+"-"+a.getDate()+" "+a.getHours()+":"+a.getMinutes()+":"+a.getSeconds(),c=e.mongo.db;c.db("vbx_current").collection("vbxReleases").findOne({version:e.payload.version},function(e,a){var p=a.dbName;(c=c.db(p)).collection("componentProperties").findOne({componentId:o},function(e,a){a.hasOwnProperty("isLocked")&&a.isLocked?n(a).code(423):c.collection("componentPropertiesDev").insertOne({newSchema:t,oldSchema:a.properties,schemaId:o,changeMsg:r,updatedBy:i,updatedOn:s,approvalStatus:"pending",prStatus:"pending"},function(e,t){if(e)return n(Boom.internal("Internal MongoDB error",e));c.collection("componentProperties").updateOne({componentId:o},{$set:{isLocked:!0}},{w:1},function(e,o){if(e)return n(Boom.internal("Internal MongoDB error",e));n(o)})})})})},exports.getComponentText=function(e,n){var o=e.mongo.db,t=e.query.schemaId;o.db("vbx_current").collection("vbxReleases").findOne({version:e.query.version},function(e,r){var i=r.dbName;(o=o.db(i)).collection("componentPropertiesDev").findOne({schemaId:t},function(e,o){if(e)return n(Boom.internal("Internal MongoDB error",e));var r=!1,i={};!function e(o){var a=(0,require("child_process").spawn)("python",["E:/VBXSUITE/VBI_DX_Suite/aps-cli/aps-web/aps-server-rest/script_generator/jsontotext.py",t,o,!0]),s="";a.stdout.on("data",function(e){s+=e.toString()}),a.stderr.on("end",function(e){if(e&&!1===r)return r=!0,n({error:!0})}),a.stdout.on("end",function(){if("old"==o)i.old=s,e("new");else if(i.new=s,!1===r)return r=!0,n(i)})}("old")})})},exports.approveSchemaChangesCB=function(e,n){var o=e.payload.component,t=e.auth.credentials.user,r=new Date,i=r.getFullYear()+"-"+(r.getMonth()+1)+"-"+r.getDate()+" "+r.getHours()+":"+r.getMinutes()+":"+r.getSeconds(),a=e.mongo.db,s=o.componentId;a.db("vbx_current").collection("vbxReleases").findOne({version:e.payload.version},function(e,o){var r=o.dbName;(a=a.db(r)).collection("componentPropertiesDev").findOne({schemaId:s,approvalStatus:"pending"},function(e,o){if(e)return n(Boom.internal("Internal MongoDB error",e));a.collection("componentProperties").updateOne({componentId:s},{$set:{properties:o.newSchema,isLocked:!1}},{w:1,upsert:!0},function(e,o){a.collection("componentPropertiesDev").updateOne({schemaId:s,approvalStatus:"pending"},{$set:{approvedBy:t,approvalStatus:"approved",approvedOn:i}},{w:1,upsert:!0},function(e,o){n({message:"success"})})})})})},exports.declineSchemaChangesCB=function(e,n){var o=e.payload.component,t=e.auth.credentials.user,r=new Date,i=r.getFullYear()+"-"+(r.getMonth()+1)+"-"+r.getDate()+" "+r.getHours()+":"+r.getMinutes()+":"+r.getSeconds(),a=e.mongo.db;a.db("vbx_current").collection("vbxReleases").findOne({version:e.payload.version},function(e,r){var s=r.dbName;(a=a.db(s)).collection("componentPropertiesDev").updateOne({schemaId:o.componentId,approvalStatus:"pending"},{$set:{declinedBy:t,approvalStatus:"declined",declinedOn:i}},{w:1,upsert:!0},function(e,t){if(e)return n(Boom.internal("Internal MongoDB error",e));a.collection("componentProperties").updateOne({componentId:o.componentId},{$set:{isLocked:!1}},{w:1,upsert:!0},function(e,o){n({message:"success"})})})})},exports.generateTextFiles=function(e,n){var o=e.mongo.db;simpleGit.checkout("xml-tool",function(){o.db("vbx_current").collection("vbxReleases").findOne({version:e.payload.version},function(e,t){var r=t.dbName;(o=o.db(r)).collection("componentPropertiesDev").find({approvalStatus:"approved",prStatus:"pending"},function(e,o){if(e)return n(Boom.internal("Internal MongoDB error",e));o.toArray().then(function(e){var o=e.length;if(0===o)return n({message:"No changes Found",changes:!1});e.forEach(function(e,t){(0,require("child_process").spawn)("python",["E:/VBXSUITE/VBI_DX_Suite/aps-cli/aps-web/aps-server-rest/script_generator/jsontotext.py",e.schemaId,"new",!1]).on("exit",function(e,t){0===--o&&n({message:"success",changes:!0})})})})})})})};var updatePullRequest=function(e,n){e.collection("componentPropertiesDev").update({approvalStatus:"approved",prStatus:"pending"},{$set:{prStatus:"approved"}},{multi:!0,upsert:!0},function(e,o){if(e)return n(Boom.internal("Internal MongoDB error",e));n({message:"Pull Request Created Successfully"})})};exports.generatePullRequestCB=function(e,n){var o=e.mongo.db;o.db("vbx_current").collection("vbxReleases").findOne({version:e.payload.version},function(e,t){var r=t.dbName;(o=o.db(r)).collection("componentPropertiesDev").find({approvalStatus:"approved",prStatus:"pending"},function(e,t){t.toArray().then(function(e){var t=_.map(e,"updatedBy"),r=_.map(e,"changeMsg");simpleGit.add("./*").commit("**XML-TOOL** - "+t.join(", ")+" - "+r.join(", "),function(e){e?console.log("failed to commit for #"):(console.log("Commited successfully"),simpleGit.pull("upstream","master",{"--no-edit":null},function(){simpleGit.add("./*").commit("Merge branch 'master' of https://github.com/visualbis/VBI_DX_Suite into xmltool").push("origin","xml-tool",function(){axios.post("https://api.github.com/repos/visualbis/VBI_DX_Suite/pulls",{title:"**XML-TOOL** Update",body:"**XML-TOOL**",head:"vbimanonmanim:xml-tool",base:"master"},{headers:{Authorization:"token "+config.get("application.gitToken")}}).then(function(e){if(201!==e.status)return n({message:"Pull request Not created"});updatePullRequest(o,n)}).catch(function(e){return n({message:"Pull request Not created"})})})}))})})})})};